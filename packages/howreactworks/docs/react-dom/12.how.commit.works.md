---
sidebar_position: 12
---

# ã‚³ãƒŸãƒƒãƒˆã®ä»•çµ„ã¿

ã‚³ãƒŸãƒƒãƒˆã¯åˆå›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ`root.render()`ï¼‰ã¾ãŸã¯æ›´æ–°æ™‚ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒçµ‚äº†ã—ãŸæ™‚ç‚¹ã§ç™ºç”Ÿã—ã¾ã™ã€‚æœ€åˆã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®æµã‚Œã‚’ã¾ãšèª¬æ˜ã—ã¾ã™ã€‚

## ã‚³ãƒ³ã‚«ãƒ¬ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒ¼ã®çµ‚äº†å‡¦ç†

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã“ã‚Œã¾ã§ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãŒå®Œäº†ã—ãŸå¾Œã€React ã¯ä»¥ä¸‹ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š

```tsx
finishConcurrentRender(root, exitStatus, finishedWork, lanes);
```

### é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£

[`finishConcurrentRender`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1055) ã®å®šç¾©ï¼š

```tsx
function finishConcurrentRender(
  root: FiberRoot,
  exitStatus: RootExitStatus,
  finishedWork: Fiber,
  lanes: Lanes
) {
  // [...code]
  commitRootWhenReady(
    root,
    finishedWork,
    workInProgressRootRecoverableErrors,
    workInProgressTransitions,
    lanes
  );
  // [...code]
}
```

### å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

1. `exitStatus`ã«ã‚ˆã‚‹åˆ†å²å‡¦ç†:

   ```tsx
   switch (existStatus) {
     case RootInProgress:
     case RootFatalErrored: {
       // é˜²å¾¡ç­–
       throw new Error("Root did not complete. This is a bug in React.");
     }

     case RootErrored:
     case RootSuspended:
     case RootCompleted: {
       // é–¢æ•°ã®å®Ÿè¡Œã‚’ç¶™ç¶š
       break;
     }
     default: {
       throw new Error("Unknown root exit status.");
     }

     case RootSuspendedWithDelay: {
       if (includesOnlyTransitions(lanes)) {
         markRootSuspended(root, lanes);
         // ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯rootã‚’suspendedã¨ãƒãƒ¼ã‚¯ã—ã¦å‡¦ç†ã‚’çµ‚äº†
         // highlight-next-line
         return;
       }
       break;
     }
   }
   ```

2. root ãŒ suspended çŠ¶æ…‹ã§ãƒªãƒˆãƒ©ã‚¤æ™‚ã®ã¿ã®å ´åˆï¼š
   ```tsx
   if (
     includesOnlyRetries(lanes) &&
     (alwaysThrottleRetries || exitStatus === RootSuspended)
   ) {
     // ...
   }
   ```
   1. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§ã®ãƒŸãƒªç§’ã‚’è¨ˆç®—ã—ã€10 ãƒŸãƒªç§’æœªæº€ã¯ç„¡è¦–ï¼š
      ```tsx
      const msUntilTimeout =
        globalMostRecentFallbackTime + FALLBACK_THROTTLE_MS - now();
      if (msUntilTimeout > 10) {
        // ...
      }
      ```
   2. `nextLanes`ã‚’è¨ˆç®—ã—ã€ä½œæ¥­ãŒãªã‘ã‚Œã°é–¢æ•°ã‚’çµ‚äº†ï¼ˆã“ã®ãƒ‘ã‚¹ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒ suspended ã•ã‚Œã€ãƒªãƒˆãƒ©ã‚¤æ™‚ã®ã¿ï¼‰ï¼š
      ```tsx
      const nextLanes = getNextLanes(root, NoLanes);
      if (nextLanes !== NoLanes) {
        return;
      }
      ```
   3. `setTimeout`ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã€æº–å‚™ãŒã§ããŸã‚‰ root ã‚’ã‚³ãƒŸãƒƒãƒˆï¼š
      ```tsx
      root.timeoutHandle = scheduleTimeout(
        commitRootWhenReady.bind(
          null,
          root,
          finishedWork,
          workInProgressRootRecoverableErrors,
          workInProgressTransitions,
          lanes
        ),
        msUntilTimeout
      );
      return;
      ```
      ã“ã‚Œã«ã‚ˆã‚Š Suspense ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã« root ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¾ã™ ğŸ˜‰
3. ãã‚Œä»¥å¤–ã®å ´åˆï¼ˆroot ãŒ suspended ã•ã‚Œã¦ãŠã‚‰ãšæ­£å¸¸ã«å®Œäº†ï¼‰ã€å³åº§ã«`commitRootWhenReady`ã‚’å‘¼ã³å‡ºã—ï¼š
   ```tsx
   commitRootWhenReady(
     root,
     finishedWork,
     workInProgressRootRecoverableErrors,
     workInProgressTransitions,
     lanes
   );
   ```

## æº–å‚™å®Œäº†æ™‚ã®ã‚³ãƒŸãƒƒãƒˆå‡¦ç†ã®ä»•çµ„ã¿

å®Ÿéš›ã®ã‚³ãƒŸãƒƒãƒˆã¯å¾Œè¿°ã™ã‚‹`commitRoot`é–¢æ•°ã§ç™ºç”Ÿã—ã¾ã™ãŒã€ã‚³ãƒ³ã‚«ãƒ¬ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯å¸¸ã«`commitRootWhenReady`ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚`performSyncWorkOnRoot`ã‹ã‚‰ã®åŒæœŸãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç‹¬ç«‹ã—ã¦`commitRoot`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

### é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£

[`commitRootWhenReady`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1147)ã®å®šç¾©ï¼š

```tsx
function commitRootWhenReady(
  root: FiberRoot,
  finishedWork: Fiber,
  recoverableErrors: Array<CapturedValue<mixed>> | null,
  transitions: Array<Transition> | null,
  lanes: Lanes
) {
  // ...
}
```

### å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

ã“ã®é–¢æ•°ã¯ã€ç·Šæ€¥ãƒ¬ãƒ¼ãƒ³ã§å‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã¯ã™ãã«`commitRoot`ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š

```tsx
if (includesOnlyNonUrgentLanes(lanes)) {
  // ... code
  return;
}
commitRoot(root, recoverableErrors, transitions);
```

<!-- Urgent lanes are as [per the definition:](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L465) -->

ç·Šæ€¥ãƒ¬ãƒ¼ãƒ³ã¯[ä»¥ä¸‹ã®å®šç¾©](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L465)ã«å¾“ã„ã¾ã™ã€‚

```tsx
const UrgentLanes = SyncLane | InputContinuousLane | DefaultLane;
return (lanes & UrgentLanes) === NoLanes;
```

- `SyncLane`
- `InputContinuousLane`
- `DefaultLane`

`root.render()`ã‹ã‚‰ç™ºç”Ÿã™ã‚‹å‡¦ç†ã¯`DefaultLane`ã«å±ã™ã‚‹ãŸã‚ã€ç·Šæ€¥ã¨ã¿ãªã•ã‚Œ`commitRoot`ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã™ã¹ã¦ã® lane ãŒéç·Šæ€¥ã®å ´åˆã€React ã¯`Suspensey commit`ã‚’å®Ÿè¡Œã—ã€ã‚³ãƒŸãƒƒãƒˆã‚’å¾Œã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ï¼š

```tsx
if (includesOnlyNonUrgentLanes(lanes)) {
  startSuspendingCommit();
  accumulateSuspenseyCommit(finishedWork);
  const schedulePendingCommit = waitForCommitToBeReady();
  if (schedulePendingCommit !== null) {
    root.cancelPendingCommit = schedulePendingCommit(
      commitRoot.bind(null, root, recoverableErrors, transitions)
    );
    markRootSuspended(root, lanes);
    return;
  }
}
```

â€» ç°¡æ½”ã•ã®ãŸã‚ã€ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ãªèª¬æ˜ã¯å‰²æ„›ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ãªè§£èª¬ãŒå¿…è¦ãªå ´åˆã¯ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ãã ã•ã„ã€‚

## `commitRoot`ã®ä»•çµ„ã¿

[`commitRoot`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2577)ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`commitRootImpl`ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š

```tsx
function commitRoot(
  root: FiberRoot,
  recoverableErrors: null | Array<CapturedValue<mixed>>,
  transitions: Array<Transition> | null
) {
  const previousUpdateLanePriority = getCurrentUpdatePriority();
  const prevTransition = ReactCurrentBatchConfig.transition;

  try {
    ReactCurrentBatchConfig.transition = null;
    setCurrentUpdatePriority(DiscreteEventPriority);
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆ-next-line
    commitRootImpl(
      root,
      recoverableErrors,
      transitions,
      previousUpdateLanePriority
    );
  } finally {
    ReactCurrentBatchConfig.transition = prevTransition;
    setCurrentUpdatePriority(previousUpdateLanePriority);
  }

  return null;
}
```

[`commitRootImpl`é–¢æ•°](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2604)ã¯éå¸¸ã«é•·ãè¤‡é›‘ã§ã€å¤šãã®ä»–ã®é–¢æ•°ã‚„å†å¸°å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ã“ã‚Œã¯éå¸¸ã«æƒ…å ±é‡ãŒå¤šãè¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãªã‚‹ãŸã‚ã€æº–å‚™ã—ã¦ãã ã•ã„ï¼

æ¬¡ã«èª¬æ˜ã™ã‚‹å†…å®¹ã®éå¸¸ã«ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆè©³ç´°ã¯`details`ã‚¿ã‚°å†…ã«è¨˜è¼‰ï¼‰ï¼š

<details>
<summary>ç°¡ç•¥åŒ–ã•ã‚ŒãŸcommitRootImplã®å…¨ä½“åƒ</summary>

```tsx
// å¤§å¹…ã«ç°¡ç•¥åŒ–
function commitRootImpl(
  root: FiberRoot,
  recoverableErrors: null | Array<CapturedValue<mixed>>,
  transitions: Array<Transition> | null,
  renderPriorityLevel: EventPriority
) {
  do {
    // well, commitRoot may be triggerred while we have a scheduled pending
    // effects processing.
    // in this case, we need to pass over them now.
    flushPassiveEffects();
  } while (rootWithPendingPassiveEffects !== null);

  if ((executionContext & (RenderContext | CommitContext)) !== NoContext) {
    throw new Error("æ—¢ã«å‡¦ç†ä¸­ã§ã‚ã£ã¦ã¯ãªã‚Šã¾ã›ã‚“");
  }

  const finishedWork = root.finishedWork;
  const lanes = root.finishedLanes;

  if (finishedWork === null) {
    return null;
  }

  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  if (finishedWork === root.current) {
    throw new Error(
      "Cannot commit the same tree as before. This error is likely caused by " +
        "a bug in React. Please file an issue."
    );
  }

  root.callbackNode = null;
  root.callbackPriority = NoLane;
  root.cancelPendingCommit = null;

  let remainingLanes = mergeLanes(
    finishedWork.lanes | finishedWork.childLanes,
    getConcurrentlyUpdatedLanes()
  );
  markRootFinished(root, remainingLanes);

  if (root === workInProgressRoot) {
    workInProgressRoot = null;
    workInProgress = null;
    workInProgressRootRenderLanes = NoLanes;
  }

  if (
    (finishedWork.subtreeFlags & PassiveMask) !== NoFlags ||
    (finishedWork.flags & PassiveMask) !== NoFlags
  ) {
    if (!rootDoesHavePassiveEffects) {
      rootDoesHavePassiveEffects = true;
      pendingPassiveEffectsRemainingLanes = remainingLanes;
      pendingPassiveTransitions = transitions;
      // highlight-next-line
      scheduleCallback(NormalSchedulerPriority, () => {
        flushPassiveEffects();
        return null;
      });
    }
  }

  const subtreeHasEffects =
    (finishedWork.subtreeFlags &
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;
  const rootHasEffect =
    (finishedWork.flags &
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;

  if (subtreeHasEffects || rootHasEffect) {
    const prevTransition = ReactCurrentBatchConfig.transition;
    ReactCurrentBatchConfig.transition = null;
    const previousPriority = getCurrentUpdatePriority();
    setCurrentUpdatePriority(DiscreteEventPriority);
    const prevExecutionContext = executionContext;
    executionContext |= CommitContext;

    ReactCurrentOwner.current = null;
    const shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(
      root,
      finishedWork
    );

    // The next phase is the mutation phase, where we mutate the host tree.
    commitMutationEffects(root, finishedWork, lanes);
    resetAfterCommit(root.containerInfo);

    // highlight-next-line
    root.current = finishedWork;

    // highlight-next-line
    commitLayoutEffects(finishedWork, root, lanes);

    requestPaint();

    executionContext = prevExecutionContext;

    setCurrentUpdatePriority(previousPriority);
    ReactCurrentBatchConfig.transition = prevTransition;
  } else {
    // No effects.
    root.current = finishedWork;
  }

  const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;

  if (rootDoesHavePassiveEffects) {
    rootDoesHavePassiveEffects = false;
    rootWithPendingPassiveEffects = root;
    pendingPassiveEffectsLanes = lanes;
  } else {
    releaseRootPooledCache(root, remainingLanes);
  }

  // Read this again, since an effect might have updated it
  remainingLanes = root.pendingLanes;

  if (remainingLanes === NoLanes) {
    legacyErrorBoundariesThatAlreadyFailed = null;
  }

  ensureRootIsScheduled(root);

  if (recoverableErrors !== null) {
    // remember this? createRoot options ğŸ˜‰
    const onRecoverableError = root.onRecoverableError;
    for (let i = 0; i < recoverableErrors.length; i++) {
      const recoverableError = recoverableErrors[i];
      const errorInfo = makeErrorInfo(
        recoverableError.digest,
        recoverableError.stack
      );
      onRecoverableError(recoverableError.value, errorInfo);
    }
  }

  if (hasUncaughtError) {
    hasUncaughtError = false;
    const error = firstUncaughtError;
    firstUncaughtError = null;
    throw error;
  }

  if (includesSyncLane(pendingPassiveEffectsLanes) && root.tag !== LegacyRoot) {
    // highlight-next-line
    flushPassiveEffects();
  }

  // Read this again, since a passive effect might have updated it
  remainingLanes = root.pendingLanes;
  if (includesSyncLane(remainingLanes)) {
    if (root === rootWithNestedUpdates) {
      nestedUpdateCount++;
    } else {
      nestedUpdateCount = 0;
      rootWithNestedUpdates = root;
    }
  } else {
    nestedUpdateCount = 0;
  }

  // highlight-next-line
  flushSyncWorkOnAllRoots();

  return null;
}
```

</details>

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç›®çš„ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¤‡æ•°ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã™ã€‚

### root ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãƒªã‚»ãƒƒãƒˆ

```tsx
const finishedWork = root.finishedWork;

root.finishedWork = null;
root.finishedLanes = NoLanes;

root.callbackNode = null;
root.callbackPriority = NoLane;
root.cancelPendingCommit = null;

root.current = finishedWork;

if (root === workInProgressRoot) {
  workInProgressRoot = null;
  workInProgress = null;
  workInProgressRootRenderLanes = NoLanes;
}
// ...å¾Œç¶šå‡¦ç†...
```

### Passive Effects ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°

React ã¯ãƒ„ãƒªãƒ¼ã‚’ã‚¹ãƒãƒ¼ãƒˆã«ã‚¿ã‚°ä»˜ã‘ã—ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å­˜åœ¨ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€å¾Œã§å‡¦ç†ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ï¼š

```tsx
if (
  (finishedWork.subtreeFlags & PassiveMask) !== NoFlags ||
  (finishedWork.flags & PassiveMask) !== NoFlags
) {
  if (!rootDoesHavePassiveEffects) {
    rootDoesHavePassiveEffects = true;
    pendingPassiveEffectsRemainingLanes = remainingLanes;
    pendingPassiveTransitions = transitions;
    // highlight-start
    scheduleCallback(NormalSchedulerPriority, () => {
      flushPassiveEffects();
      return null;
    });
    // highlight-end
  }
}
```

ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯éåŒæœŸã§å®Ÿè¡Œã•ã‚Œã€React ãŒä»–ã®ã‚¿ã‚¤ãƒ—ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å‡¦ç†ã™ã‚‹æ™‚é–“ã‚’ç¢ºä¿ã—ã¾ã™ã€‚

### ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å®Ÿè¡Œ

React ã¯è¤‡æ•°ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ã“ã“ã§ã¾ã¨ã‚ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

```tsx
const subtreeHasEffects =
  (finishedWork.subtreeFlags &
    (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
  NoFlags;
const rootHasEffect =
  (finishedWork.flags &
    (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
  NoFlags;

if (rootHasEffect || subtreeHasEffects) {
  const prevTransition = ReactCurrentBatchConfig.transition;
  ReactCurrentBatchConfig.transition = null;
  const previousPriority = getCurrentUpdatePriority();
  setCurrentUpdatePriority(DiscreteEventPriority);
  const prevExecutionContext = executionContext;
  executionContext |= CommitContext;
  ReactCurrentOwner.current = null;

  // highlight-next-line
  commitBeforeMutationEffects(root, finishedWork);
  // highlight-next-line
  commitMutationEffects(root, finishedWork, lanes);
  resetAfterCommit(root.containerInfo);
  // highlight-next-line
  root.current = finishedWork;
  // highlight-next-line
  commitLayoutEffects(finishedWork, root, lanes);
  // highlight-next-line
  requestPaint();

  executionContext = prevExecutionContext;
  setCurrentUpdatePriority(previousPriority);
  ReactCurrentBatchConfig.transition = prevTransition;
}

if (recoverableErrors !== null) {
  // createRootã®onRecoverableErrorã‚ªãƒ—ã‚·ãƒ§ãƒ³
  callRootOnRecoverableErrors(root);
}

if (hasUncaughtError) {
  hasUncaughtError = false;
  const error = firstUncaughtError;
  firstUncaughtError = null;
  throw error;
}

// highlight-next-line
if (includesSyncLane(pendingPassiveEffectsLanes) && root.tag !== LegacyRoot) {
  // highlight-next-line
  flushPassiveEffects();
  // highlight-next-line
}

// [...] ã‚³ãƒŸãƒƒãƒˆå‡¦ç†ã®ç¶šã
```

React ã¯ä»¥ä¸‹ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ï¼š

#### 1. Before mutation effects

[ã“ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L372)ã¯ã€å‰ã®ãƒ„ãƒªãƒ¼ã‚’å¤‰æ›´ã™ã‚‹å‰ã«ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®[`getSnapshotBeforeUpdate`](https://react.dev/reference/react/Component#getsnapshotbeforeupdate)ã‚„å®Ÿé¨“çš„ãª`useEffectEvent`ã®å‘¼ã³å‡ºã—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

å®Œå…¨ãªå‡¦ç†ã¯[ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L441)

#### 2. Mutation effects

[Mutation effects](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L2541)ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

1. **å‰Šé™¤ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**: å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®[ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L2020)
2. **Reconciliation ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**: æ–°ã—ã„ DOM ãƒãƒ¼ãƒ‰ã‚’[æ­£ã—ã„ä½ç½®ã«æŒ¿å…¥](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L1808)
3. **æ›´æ–°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**: DOM ãƒãƒ¼ãƒ‰ã‚’[ç¾åœ¨ã®ãƒ¬ãƒ³ãƒ€ãƒ¼å€¤ã§æ›´æ–°](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js#L690)
4. **æŒ¿å…¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: [`useInsertionEffect`ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L2562)
5. **æŒ¿å…¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**: [`useInsertionEffect`ã®å®Ÿè¡Œ](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L2567)
6. **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: è©³ç´°ã¯[Andrew ã®ã‚³ãƒ¡ãƒ³ãƒˆ](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L2574)ã‚’å‚ç…§

:::tip
æ³¨æ„ç‚¹ï¼š

- Layout ã¨ passive effects ã¯`ä¸‹ã‹ã‚‰ä¸Šã¸`å®Ÿè¡Œ
- Layout ã¨ passive effects ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯`ä¸Šã‹ã‚‰ä¸‹ã¸`å®Ÿè¡Œ
- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯å®Ÿéš›ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå®Ÿè¡Œå‰ã«ä¸€æ‹¬å‡¦ç†ï¼ˆä¸Šã‹ã‚‰ä¸‹ã¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã€ä¸‹ã‹ã‚‰ä¸Šã¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå®Ÿè¡Œï¼‰
- `useInsertionEffect`ã¯ layout/passive effects ã¨ã¯ç•°ãªã‚‹é †åº
- `useInsertionEffect`ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§`ä¸‹ã‹ã‚‰ä¸Šã¸`å®Ÿè¡Œ
  :::

#### 3. Layout effects

[Layout effects](https://github.com/facebook/react/blob/7f6201889e8e628eeb53e05d8850ddffa3c2e74a/packages/react-reconciler/src/ReactFiberCommitWork.js#L3099)ã¯åŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚

å‡¦ç†å†…å®¹ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ï¼š

- é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: `useLayoutEffect`
- ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: `componentDidMount`ã€`componentDidUpdate`
- Ref ã®ã‚¢ã‚¿ãƒƒãƒ

#### 4. Passive effects

`SyncLane`ã§ã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã¯ passive effects ã‚‚åŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã¾ã™ï¼ˆä¸€èˆ¬çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

é`SyncLane`ã§ã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã¯ã€`commitRootImpl`ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸé€šã‚Šã«éåŒæœŸå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
