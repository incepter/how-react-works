---
sidebar_position: 12
---

# How Commit works

The commit will occur when render finishes either for the first time from 
`root.render()` or on updates. We will discuss first when coming from the first
render.


## How finishing concurrent render works
After your initial application render and all the mechanics we've seen before,
React will call:

```tsx
finishConcurrentRender(root, exitStatus, finishedWork, lanes);
```


### Signature
[`finishConcurrentRender`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1055)
is defined as follows:
```tsx
function finishConcurrentRender(
  root: FiberRoot,
  exitStatus: RootExitStatus,
  finishedWork: Fiber,
  lanes: Lanes,
) {
  
}
```

### Implementation steps

1. Switch over the `exitStatus`:
   ```tsx
   switch(existStatus) {
     case RootInProgress:
     case RootFatalErrored: {
       // defensive guard
       throw new Error('Root did not complete. This is a bug in React.');
     }
   
     case RootErrored:
     case RootSuspended:
     case RootCompleted: {
       // continue function execution
       break;
     }
     default: {
       throw new Error('Unknown root exit status.');
     }
   
     case RootSuspendedWithDelay: {
       if (includesOnlyTransitions(lanes)) {
         markRootSuspended(root, lanes);
         // this function will only mark root suspended and quit in this case
         // highlight-next-line
         return;
       }
       break;
    }
   }
   ```
   
2. When root is suspended and only on retries, then:
   ```tsx
   if (
      includesOnlyRetries(lanes) &&
      (alwaysThrottleRetries || exitStatus === RootSuspended)
    ) {
     // ...
   }
   ```
   1. Compute the milliseconds until timeout and ignore timeouts less than 10 millis
      ```tsx
      const msUntilTimeout = globalMostRecentFallbackTime + FALLBACK_THROTTLE_MS - now();
      if (msUntilTimeout > 10) {
        // ...
      }
      ```
   2. Compute `nextLanes` and quit the function if there is no work; remember,
      this path is when the render suspended and only when React
      is retrying the render.
      ```tsx
      const nextLanes = getNextLanes(root, NoLanes);
      if (nextLanes !== NoLanes) {
         return;
      }
      ```
   3. schedule a timeout via `setTimeout` to commit the root when ready and quit:
      ```tsx
      root.timeoutHandle = scheduleTimeout(
        commitRootWhenReady.bind(
          null,
          root,
          finishedWork,
          workInProgressRootRecoverableErrors,
          workInProgressTransitions,
          lanes,
        ),
        msUntilTimeout,
      );
      return;
      ```
      This will commit the root to show the suspense fallback ðŸ˜‰
3. Otherwise, when root isn't suspended and completed successfully, then it will
   call `commitRootWhenReady` right away:
      ```tsx
      commitRootWhenReady(
        root,
        finishedWork,
        workInProgressRootRecoverableErrors,
        workInProgressTransitions,
        lanes,
      );
      ```

## How Commit work when ready works
The real commit happens at the `commitRoot` function that we will see in a few,
but it is always called from `commitRootWhenReady` for concurrent renders,
sync render from `performSyncWorkOnRoot` will call `commitRoot` independently.

### Signature
[`commitRootWhenReady`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1147)
is defined as follows

```tsx
function commitRootWhenReady(
  root: FiberRoot,
  finishedWork: Fiber,
  recoverableErrors: Array<CapturedValue<mixed>> | null,
  transitions: Array<Transition> | null,
  lanes: Lanes,
) {
  // ...
}
```

### Implementation steps

This function will call commitRoot immediately if it is called with an urgent
lane:

```tsx
if (includesOnlyNonUrgentLanes(lanes)) {
  // ... code
  return;
}
commitRoot(root, recoverableErrors, transitions);
```

Urgent lanes are as [per the definition:](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L465)
```tsx
const UrgentLanes = SyncLane | InputContinuousLane | DefaultLane;
return (lanes & UrgentLanes) === NoLanes;
```

- `SyncLane`
- `InputContinuousLane`
- `DefaultLane`

So coming from root.render() will be in a DefaultLane and thus considered as
urgent and will call `commitRoot`.

When all lanes aren't urgent, React will perform a `Suspensey commit` by
scheduling the commit for later:

```tsx
if (includesOnlyNonUrgentLanes(lanes)) {
  startSuspendingCommit();
  accumulateSuspenseyCommit(finishedWork);
  const schedulePendingCommit = waitForCommitToBeReady();
  if (schedulePendingCommit !== null) {
    root.cancelPendingCommit = schedulePendingCommit(
      commitRoot.bind(null, root, recoverableErrors, transitions),
    );
    markRootSuspended(root, lanes);
    return;
  }
}
```

_The previous code isn't explained in this section to keep it short.
If you are curious about it and want it explained, please open an issue._

## How `commitRoot` works:

[`commitRoot`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2577)
