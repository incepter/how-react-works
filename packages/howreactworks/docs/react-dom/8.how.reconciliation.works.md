---
sidebar_position: 8
---

# Reconciliation ã®ä»•çµ„ã¿

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã€reconciliationï¼ˆèª¿æ•´å‡¦ç†ï¼‰ã¯ç¾åœ¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã® fiber ã®æœ€åˆã®å­è¦ç´ ã‚’è¨ˆç®—ã—ã¦å‡¦ç†ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ã“ã®å‡¦ç†ã¯å†å¸°çš„ã«ãƒ„ãƒªãƒ¼ã®æœ€ä¸‹éƒ¨ã«åˆ°é”ã™ã‚‹ã¾ã§ç¶šãã€ãã®å¾Œ`completeWork`ãŒé–‹å§‹ã•ã‚Œã¦ãƒ„ãƒªãƒ¼ã‚’é¡ã‚Šå§‹ã‚ã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã§æœ€åˆã« reconciliation ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã¯`HostRoot`ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹æ™‚ã§ã€`root.render()`ã«æ¸¡ã•ã‚ŒãŸæ¬¡ã®å­è¦ç´ ã¸ã®é·ç§»ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãã®å¾Œã‚‚ reconciliation ã¯åŒã˜ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã«å¾“ã„ã€å¸¸ã«æ¬¡ã®å­è¦ç´ ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

# `reconcileChildren`ã®ä»•çµ„ã¿

[`reconcileChildren`](https://github.com/facebook/react/blob/eaa696876ee40bb048727aefe995be1bbb7384a8/packages/react-reconciler/src/ReactFiberBeginWork.js#L326)ã¯ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã™ï¼š

```tsx
export function reconcileChildren(
  current: Fiber | null, // ç¾åœ¨è¡¨ç¤ºä¸­ã®fiber
  workInProgress: Fiber, // ãã®ä»£æ›¿fiber
  nextChildren: any, // æ¬¡ã®å­è¦ç´ 
  renderLanes: Lanes // ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ¬ãƒ¼ãƒ³
) {
  if (current === null) {
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes
    );
  } else {
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes
    );
  }
}

function reconcileChildFibers(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChild: any,
  lanes: Lanes
) {
  thenableIndexCounter = 0;
  // highlight-next-line
  const firstChildFiber = reconcileChildFibersImpl(
    returnFiber,
    currentFirstChild,
    newChild,
    lanes
  );
  thenableState = null;
  return firstChildFiber;
}
```

ã“ã®é–¢æ•°ã¯`ReactChildFiber`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹[`reconcileChildFibers`](https://github.com/facebook/react/blob/afea1d0c536e0336735b0ea5c74f635527b65785/packages/react-reconciler/src/ReactChildFiber.js#L1485)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ˜ç¢ºåŒ–ã®ãŸã‚ã€thenable ã«é–¢ã™ã‚‹èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚

ç¶šã„ã¦ã€`reconcileChildFibersImpl`ãŒåŒã˜å¼•æ•°ã§å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

## `reconcileChildFibersImpl`ã®ä»•çµ„ã¿

[ã“ã®é–¢æ•°](https://github.com/facebook/react/blob/afea1d0c536e0336735b0ea5c74f635527b65785/packages/react-reconciler/src/ReactChildFiber.js#L1344)ã¯æœ€åˆã«ä½¿ç”¨ã™ã‚‹æ¬¡ã®å­è¦ç´ ã‚’æ±ºå®šã—ã¾ã™ã€‚ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã® Fragment ã§ key ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã€ãã‚Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

:::note
ã“ã‚Œã¯å®Ÿéš›ã«è½ã¨ã—ç©´ã«ãªã‚Šå¾—ã¾ã™ï¼

React ã¯ key ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã—ã¦ fiber ã‚’ä½œæˆã—ã¾ã›ã‚“ã€‚
:::

:::tip
é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã‹ã‚‰ã€reconciliation ã®ç›®çš„ãŒå®Ÿéš›ã«ã¯`ReactNode`ã‚’åŒç­‰ã®`Fiber`ã«å¤‰æ›ã™ã‚‹ã“ã¨ã ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚
:::

```tsx
function reconcileChildFibersImpl(
  returnFiber: Fiber, // è¦ªfiber
  currentFirstChild: Fiber | null, // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœ€åˆã®å­è¦ç´ ã®fiber
  newChild: any, // æ¬¡ã®Reactãƒãƒ¼ãƒ‰
  lanes: Lanes // ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ¬ãƒ¼ãƒ³
): Fiber | null {
  const isUnkeyedTopLevelFragment =
    typeof newChild === "object" && // Reactè¦ç´ ï¼ˆé…åˆ—ã§ã¯ãªã„ï¼‰
    newChild !== null && // typeof nullã¯object ğŸ™„
    newChild.type === REACT_FRAGMENT_TYPE && // Fragment
    newChild.key === null; // keyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

  if (isUnkeyedTopLevelFragment) {
    // highlight-next-line
    newChild = newChild.props.children;
  }

  if (typeof newChild === "object" && newChild !== null) {
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆReactè¦ç´ ã€é…åˆ—ãªã©ï¼‰ã‚’å‡¦ç†
  }

  if (
    (typeof newChild === "string" && newChild !== "") ||
    typeof newChild === "number"
  ) {
    // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’å‡¦ç†
  }

  if (__DEV__) {
    if (typeof newChild === "function") {
      warnOnFunctionType(returnFiber);
    }
  }
  // æ®‹ã‚Šã®ã‚±ãƒ¼ã‚¹ã¯ã™ã¹ã¦ç©ºã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
  return deleteRemainingChildren(returnFiber, currentFirstChild);
}
```

å—ã‘å–ã£ãŸ`newChild`ï¼ˆ`nextChildren`ï¼‰ãŒ null ã§ã¯ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€2 ã¤ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼šå˜ä¸€ãƒãƒ¼ãƒ‰ã‹ã€è¤‡æ•°ã®å­è¦ç´ ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ä»¥ä¸‹ãŒãã‚Œã‚‰ã‚’åŒºåˆ¥ã™ã‚‹æ–¹æ³•ã§ã™ï¼š

```tsx
if (typeof newChild === "object" && newChild !== null) {
  // å˜ä¸€ã®å­è¦ç´ 
  switch (newChild.$$typeof) {
  }

  // å­è¦ç´ ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
  if (isArray(newChild)) {
  }
  if (getIteratorFn(newChild)) {
  }

  // éåŒæœŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  if (typeof newChild.then === "function") {
  }
  throwOnInvalidObjectType(returnFiber, newChild);
}
```

## å˜ä¸€å­è¦ç´ ã® reconciliation ã®ä»•çµ„ã¿

æœ‰åŠ¹ãª`$$typeof`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤å˜ä¸€ã®å­è¦ç´ ãŒã‚ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ãŒå‡¦ç†ã•ã‚Œã¾ã™ï¼š

```tsx
switch (newChild.$$typeof) {
  case REACT_ELEMENT_TYPE:
    return placeSingleChild(
      reconcileSingleElement(returnFiber, currentFirstChild, newChild, lanes)
    );
  case REACT_PORTAL_TYPE:
    return placeSingleChild(
      reconcileSinglePortal(returnFiber, currentFirstChild, newChild, lanes)
    );
  case REACT_LAZY_TYPE:
    const payload = newChild._payload;
    const init = newChild._init;
    return reconcileChildFibers(
      returnFiber,
      currentFirstChild,
      init(payload),
      lanes
    );
}
```

ä¸Šè¨˜ã§ä½¿ç”¨ã•ã‚Œã‚‹ä¸»è¦ãªé–¢æ•°ï¼š

- `placeSingleChild`
- `reconcileSingleChild`
- `reconcileSinglePortal`
- é…å»¶å‹ã®å†å¸°å‡¦ç†ï¼šã“ã®å†å¸°ã¯ä¸»ã« thenables ã‚±ãƒ¼ã‚¹ã«è©²å½“ã—ã€å†åº¦ reconciliation ã«å…¥ã‚Šã¾ã™

### `reconcileSingleElement`ã®ä»•çµ„ã¿

[ã“ã®é–¢æ•°](https://github.com/facebook/react/blob/afea1d0c536e0336735b0ea5c74f635527b65785/packages/react-reconciler/src/ReactChildFiber.js#L1228-L1233)ã¯åŒã˜ã‚·ã‚°ãƒãƒãƒ£ã‚’ä¿æŒã—ã¾ã™ãŒã€ä»Šå›ã®`newChild`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯`ReactElement`ã§ã‚ã‚‹ã“ã¨ãŒæ˜ç¢ºã§ã™ï¼š

```tsx
function reconcileSingleElement(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  element: ReactElement,
  lanes: Lanes
): Fiber {
  const key = element.key; // æ–°ã—ã„key
  let child = currentFirstChild;

  // å‰ã®ãƒ„ãƒªãƒ¼ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦åŒã˜keyã‚’æŒã¤è¦ç´ ã‚’æ¤œç´¢
  while (child !== null) {
    // æœ€åˆã«keyã‚’æ¯”è¼ƒ
    if (child.key === key) {
      // æ¬¡ã«elementTypeã«åŸºã¥ã„ã¦ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      const elementType = element.type; // æ–°ã—ã„è¦ç´ ã‚¿ã‚¤ãƒ—
    } else {
      deleteChild(returnFiber, child);
    }

    child = child.sibling;
  }

  if (element.type === REACT_FRAGMENT_TYPE) {
    // ...
  } else {
    // ...
  }
}
```

ã”è¦§ã®é€šã‚Šã€`reconcileSingleElement`ã¯æœ€åˆã«æ—¢å­˜ã®å­è¦ç´ ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€åŒã˜ key ã‚’æŒã¤è¦ç´ ã‚’æ¢ã—ã¾ã™ã€‚

è¦‹ã¤ã‹ã£ãŸå ´åˆã€`element.type`ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€Fragment ã‚¿ã‚¤ãƒ—ã«å¯¾ã—ã¦ç‰¹åˆ¥ãªå‡¦ç†ãƒ‘ã‚¹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```tsx
while (child !== null) {
  if (child.key === key) {
    const elementType = element.type;
    if (elementType === REACT_FRAGMENT_TYPE) {
      if (child.tag === Fragment) {
        // ã“ã“ã§ã¯ä»¥å‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­
        // highlight-next-line
        deleteRemainingChildren(returnFiber, child.sibling);
        // highlight-next-line
        const existing = useFiber(child, element.props.children);
        existing.return = returnFiber;
        // highlight-next-line
        return existing;
      }
      // Fragmentã§ãªã„å ´åˆã€deleteChildã«ãƒ•ã‚©ãƒ¼ãƒ«ã‚¹ãƒ«ãƒ¼
    } else {
      // é€šå¸¸ã®è¦ç´ ï¼ˆFragmentä»¥å¤–ï¼‰ã®å ´åˆ
      if (
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒåŒã˜ã¾ã¾
        child.elementType === elementType ||
        // React.lazyã®ç‰¹åˆ¥ã‚±ãƒ¼ã‚¹
        (typeof elementType === "object" &&
          elementType !== null &&
          elementType.$$typeof === REACT_LAZY_TYPE &&
          resolveLazy(elementType) === child.type)
      ) {
        // highlight-next-line
        deleteRemainingChildren(returnFiber, child.sibling);
        // highlight-next-line
        const existing = useFiber(child, element.props);
        // highlight-next-line
        existing.ref = coerceRef(returnFiber, child, element);
        existing.return = returnFiber;
        // highlight-next-line
        return existing;
      }
    }
    deleteRemainingChildren(returnFiber, child);
    break;
  } else {
    // highlight-next-line
    deleteChild(returnFiber, child);
  }

  // highlight-next-line
  child = child.sibling;
}
```

ä¸€è‡´ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€React ã¯`deleteRemainingChildren`ã‚’å®Ÿè¡Œã—ã€æ—¢å­˜ã® fiber ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦è¦ªï¼ˆ`returnFiber`ï¼‰ã«ã‚¢ã‚¿ãƒƒãƒã—ã€ãã‚Œã‚’è¿”ã—ã¾ã™ã€‚
Fragment ã¯ ref ã‚’æŒãŸãªã„ãŸã‚ã€`coerceRef`ã®éƒ¨åˆ†ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚

[`deleteRemainingChildren`](https://github.com/facebook/react/blob/afea1d0c536e0336735b0ea5c74f635527b65785/packages/react-reconciler/src/ReactChildFiber.js#L306)ã¯ã€æŒ‡å®šã•ã‚ŒãŸè¦ç´ ã‹ã‚‰é–‹å§‹ã—ã¦ return fiber ã®å­è¦ç´ é…åˆ—ã‹ã‚‰ã™ã¹ã¦ã® fiber ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

ã“ã®å‰Šé™¤ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€å‰Šé™¤ã•ã‚ŒãŸ fiber ã‚’è¦ªã®`deletions`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã—ã¾ã™ï¼š

```tsx
// simplified
function deleteRemainingChildren(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null
): null {
  let childToDelete = currentFirstChild;
  while (childToDelete !== null) {
    deleteChild(returnFiber, childToDelete);
    childToDelete = childToDelete.sibling;
  }
  return null;
}

function deleteChild(returnFiber: Fiber, childToDelete: Fiber): void {
  const deletions = returnFiber.deletions;
  if (deletions === null) {
    returnFiber.deletions = [childToDelete];
    returnFiber.flags |= ChildDeletion;
  } else {
    deletions.push(childToDelete);
  }
}
```

å‰ã®ãƒ„ãƒªãƒ¼ã‚’å‡¦ç†ã—ã¦ã‚‚ä¸€è‡´ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆï¼ˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã¯ç¾åœ¨ã®ãƒ„ãƒªãƒ¼ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æœ€åˆã‹ã‚‰ã“ã“ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ï¼‰ã€React ã¯ä¸ãˆã‚‰ã‚ŒãŸ React è¦ç´ ã‹ã‚‰æ–°ã—ã„ Fiber ã‚’ä½œæˆã—ã¦è¿”ã—ã¾ã™ã€‚

```tsx
if (element.type === REACT_FRAGMENT_TYPE) {
  const fiber = createFiberFromFragment(
    element.props.children, // props
    returnFiber.mode, // mode
    lanes, // ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ¬ãƒ¼ãƒ³
    element.key // key
  );
  fiber.return = returnFiber;
} else {
  const created = createFiberFromElement(element, returnFiber.mode, lanes);
  created.ref = coerceRef(returnFiber, currentFirstChild, element);
  created.return = returnFiber;
  return created;
}
```

Fiber ã®ä½œæˆã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ã—ãèª¬æ˜ã—ã€å„ã‚¿ã‚¤ãƒ—ã”ã¨ã®å‡¦ç†æ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

#### `coerceRef`

import TBD from "./components/TBDBanner"
<TBD />

### How `reconcileSinglePortal` works

<TBD />

### `placeSingleChild`ã®ä»•çµ„ã¿

[`placeSingleChild`é–¢æ•°](https://github.com/facebook/react/blob/afea1d0c536e0336735b0ea5c74f635527b65785/packages/react-reconciler/src/ReactChildFiber.js#L385)ã¯ã€æœ€åˆã«æ§‹ç¯‰ã•ã‚ŒãŸæ™‚ï¼ˆä»£æ›¿ fiber ãŒãªã„å ´åˆï¼‰ã«`Placement`ãƒ•ãƒ©ã‚°ã‚’ fiber ã«ãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚

```tsx
if (shouldTrackSideEffects && newFiber.alternate === null) {
  newFiber.flags |= Placement | PlacementDEV;
}
return newFiber;
```

### How `reconcile lazy` works

<TBD />

## How children array reconciliation works

<TBD />

### How `reconcileChildrenArray` works

<TBD />

### How `reconcileChildrenIterator` works

<TBD />

## How text nodes reconciliation works

<TBD />
