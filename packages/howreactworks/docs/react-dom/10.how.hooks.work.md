---
sidebar_position: 10
---

# ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

## ã¯ã˜ã‚ã«

React v16.8.0 ã§å°å…¥ã•ã‚ŒãŸ[ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/hooks)ã¯ã€React ã‚¢ãƒ—ãƒªã®æ›¸ãæ–¹ã‚’å¤‰é©ã—ã¾ã—ãŸã€‚ãƒ•ãƒƒã‚¯ä»¥å‰ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆã‚„ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã€ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ•ãƒƒã‚¯ã®ç™»å ´ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ React ã‚¢ãƒ—ãƒªé–‹ç™ºã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã¨ãªã‚Šã¾ã—ãŸã€‚

ãƒ•ãƒƒã‚¯ã¯å¤šãã®ã“ã¨ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã—ã¾ã—ãŸï¼ˆã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚ˆã‚Šå„ªã‚Œã¦ã„ã‚‹ã¨è¨€ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ¨è«–ã‚„æ‰±ã„ã‚’å®¹æ˜“ã«ã—ã€`this`ã®æ‰±ã„ã‹ã‚‰è§£æ”¾ã•ã‚Œã‚‹ãªã©ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ãƒ•ãƒƒã‚¯è‡ªä½“ã®èª¬æ˜ã¯ååˆ†ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ React å†…éƒ¨ã§ã®å®Ÿè£…æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

å‰ç« ã®ã€Œãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹æ³•ã€ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã‹æ›´æ–°æ™‚ã‹ã«åŸºã¥ã„ã¦`Dispatcher`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚ã“ã® Dispatcher ã®æ­£ä½“ã‚’è§£æ˜ã—ã¾ã—ã‚‡ã†ã€‚

## `ReactCurrentDispatcher`

[`renderWithHooks`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L556)é–¢æ•°å†…ã§ã€`ReactCurrentDispatcher.current`ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã¯ React ã®ã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯å®Ÿè£…ã‚’å«ã‚€ãƒ—ãƒ¬ãƒ¼ãƒ³ãª JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

Dispatcher ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„ã¯ã€ãƒ•ãƒƒã‚¯ã®ä½¿ç”¨ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã«ã‚ã‚Šã¾ã™ï¼š

- ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºå¤–ã§ã®ãƒ•ãƒƒã‚¯ä½¿ç”¨ã‚’ç¦æ­¢ï¼ˆæ‰‹å‹•ã§ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ãŸå ´åˆãªã©ï¼‰
- ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨æ›´æ–°æ™‚ã§ç•°ãªã‚‹ãƒ•ãƒƒã‚¯ã®æŒ™å‹•ï¼ˆãƒã‚¦ãƒ³ãƒˆæ™‚ã¯ãƒ•ãƒƒã‚¯ã®ä½ç½®ç¢ºä¿ã¨åˆæœŸåŒ–ã€æ›´æ–°æ™‚ã¯æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œï¼‰

Dispatcher ã«ã¯ React ã®ãƒ•ãƒƒã‚¯ã«å¯¾å¿œã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã¾ã™ï¼š

```tsx
export const AllDispatchers: Dispatcher = {
  readContext,

  use,
  useCallback: hook,
  useContext: hook,
  useEffect: hook,
  useImperativeHandle: hook,
  useInsertionEffect: hook,
  useLayoutEffect: hook,
  useMemo: hook,
  useReducer: hook,
  useRef: hook,
  useState: hook,
  useDebugValue: hook,
  useDeferredValue: hook,
  useTransition: hook,
  useSyncExternalStore: hook,
  useId: hook,
};
```

Dispatcher ã«ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ãŒã€ä¸»ã« 4 ã¤ã‚’è§£èª¬ã—ã¾ã™ï¼š

- `ContextOnlyDispatcher`: [ã“ã® Dispatcher](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L3408)
  ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºå¤–ã§ã®ãƒ•ãƒƒã‚¯ä½¿ç”¨ã‚’é˜²ãã¾ã™ã€‚ã„ã‚ã‚†ã‚‹ã€ŒInvalid hook callã€[ã‚¨ãƒ©ãƒ¼](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L440)ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™
- `HooksDispatcherOnMount`: [ã“ã® Dispatcher](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L3446)
  ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆå›ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹éš›ã®ãƒ•ãƒƒã‚¯å®Ÿè£…ã‚’å«ã¿ã¾ã™
- `HooksDispatcherOnUpdate`: [ã“ã® Dispatcher](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L3484)
  ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹éš›ã®ãƒ•ãƒƒã‚¯å®Ÿè£…ã‚’å«ã¿ã¾ã™
- `HooksDispatcherOnRerender`: [ã“ã® Dispatcher](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L3522)
  ã¯ä»¥ä¸‹ã®å ´åˆã®å†ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š
  - ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºä¸­ã«çŠ¶æ…‹æ›´æ–°ãŒç™ºç”Ÿã—ãŸå ´åˆ
  - é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ 2 å›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹å ´åˆ

## ãƒ•ãƒƒã‚¯ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°

å„ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚ã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯å‘¼ã³å‡ºã—ã¯`renderWithHooks`é–¢æ•°å†…ã§ç™ºç”Ÿã—ã¾ã™ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ãƒ•ãƒƒã‚¯ã¯`renderWithHooksAgain`é–¢æ•°ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ä¾‹å¤–ã‚’é™¤ãï¼‰ã€‚

ãƒ•ãƒƒã‚¯ã¯[é–¢é€£ã™ã‚‹`Fiber`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L965)ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

ãƒ•ãƒƒã‚¯ã¯ React å†…éƒ¨ã§ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼š

```tsx
const hook: Hook = {
  memoizedState: null,

  baseState: null,
  baseQueue: null,
  queue: null,

  next: null,
};
```

å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å½¹å‰²ï¼š

- `memoizedState`: ãƒ•ãƒƒã‚¯ã®ã€Œã‚¹ãƒ†ãƒ¼ãƒˆã€ï¼ˆã¾ãŸã¯å€¤ï¼‰ã‚’ä¿æŒ
- `baseState`: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒƒã‚¯ãŒåˆæœŸå€¤ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨
- `baseQueue`:
- `queue`: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒƒã‚¯ãŒæ§˜ã€…ãªæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã® UpdateQueue ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `next`: æ¬¡ã®ãƒ•ãƒƒã‚¯ã‚’æŒ‡ã™

`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹æ¬¡ã®ãƒ•ãƒƒã‚¯ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã‹ã‚‰ã€ãƒ•ãƒƒã‚¯ã¯å‰è¿°ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã¨ã—ã¦ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

å„ãƒ•ãƒƒã‚¯ã¯ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä½•ã‚’ä¿å­˜ã™ã‚‹ã‹ã«ã¤ã„ã¦ç‹¬è‡ªã®ä»•æ§˜ã‚’æŒã¡ã€æ˜ã‚‰ã‹ã«ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ãªã„ãƒ•ãƒƒã‚¯ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã¯ãƒ•ãƒƒã‚¯ã®ç¨®é¡ã«é–¢ã™ã‚‹æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ãƒ•ãƒƒã‚¯ã¯å‘¼ã³å‡ºã—é †åºã«ä¾å­˜ã—ã€å¸¸ã«ä¿å­˜ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![fiber and hook](imgs/10.fiber_and_hook.png)

Dan Abramov ã¯ã“ã®è¨­è¨ˆé¸æŠã«ã¤ã„ã¦[å„ªã‚ŒãŸãƒ–ãƒ­ã‚°è¨˜äº‹](https://overreacted.io/why-do-hooks-rely-on-call-order/)ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚

### ãƒ•ãƒƒã‚¯ã®ä¾‹

ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¨ä»®å®šã—ã¾ã™ï¼š

```tsx
function MyFunctionComponent(props) {
  const [count, setCount] = React.useState(0);
  // ãƒ‡ãƒ¢ç”¨ã®ãŸã‚å®Ÿéš›ã«ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“
  const isMounted = React.useRef(false);
  // ãƒ‡ãƒ¢ç”¨ã®ãŸã‚å®Ÿéš›ã«ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“
  const mountDate = React.useMemo(() => Date.now(), []);

  React.useEffect(() => {
    function handler() {
      console.log("window is focused");
    }

    window.addEventListener("focus", handler);
    return () => window.removeEventListener("focus", handler);
  }, []);

  return <span>Count is {count}</span>;
}
```

ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¨ã€`FunctionComponent`ã‚¿ã‚°ã®`Fiber`ãŒç”Ÿæˆã•ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒƒã‚¯ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ï¼š

```tsx
let memoizedState = {
  // useState
  memoizedState: 0,
  baseState: 0,
  baseQueue: null,
  queue: {
    pending: null,
    lanes: 0,
    lastRenderedState: 0,
  },
  next: {
    // useRef
    memoizedState: {
      current: false,
    },
    baseState: null,
    baseQueue: null,
    queue: null,
    next: {
      // useMemo
      memoizedState: [1700218172414, []],
      baseState: null,
      baseQueue: null,
      queue: null,
      next: {
        // useEffect
        memoizedState: {
          tag: 9,
          inst: {},
          deps: [],
          next: "the same effect .. removed for clarity",
        },
        baseState: null,
        baseQueue: null,
        queue: null,
        next: null,
      },
    },
  },
};
```

## ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ãƒ•ãƒƒã‚¯ã®ç›®çš„ã¯ã€ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã®ãƒ•ãƒƒã‚¯ã®ä½ç½®ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ã§ã™ã€‚

ãã®ãŸã‚ã€ã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯å®Ÿè£…ã¯ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’æœ€åˆã«è¡Œã„ã¾ã™ï¼š

```tsx
const hook = mountWorkInProgressHook();
```

`mountWorkInProgressHook`é–¢æ•°ã¯å‰è¿°ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½œæˆã—ã€ãã‚Œã‚’`currentlyRenderingFiber`ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã—ã¾ã™ã€‚

### `mountWorkInProgressHook`ã®å®Ÿè£…

ãƒã‚¦ãƒ³ãƒˆä¸­ã®ãƒ•ãƒƒã‚¯é–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š

```tsx
function mountWorkInProgressHook(): Hook {
  const hook: Hook = {
    memoizedState: null,

    baseState: null,
    baseQueue: null,
    queue: null,

    next: null,
  };

  if (workInProgressHook === null) {
    // ã“ã‚Œã¯ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ•ãƒƒã‚¯ã§ã™
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¿½åŠ 
    workInProgressHook = workInProgressHook.next = hook;
  }
  return workInProgressHook;
}
```

- æœ€åˆã«ãƒ•ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™
- ãã®å¾Œã€ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ•ãƒƒã‚¯ã§ã‚ã‚‹å ´åˆã€ãã‚Œã‚’`currentlyRenderingFiber`ã®`memoizedState`ã«ã‚¢ã‚¿ãƒƒãƒã—ã€`workInProgressHook`ã«ã‚‚è¨­å®šã—ã¾ã™
- ãã‚Œä»¥å¤–ã®å ´åˆã€`workInProgressHook`ã®`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™

ä»¥ä¸Šã§ã™ï¼

ãƒ•ãƒƒã‚¯ã«ã‚ˆã£ã¦ã¯ã€ä»–ã®å‡¦ç†ã‚‚è¡Œã‚ã‚Œã¾ã™ãŒã€ãã‚Œãã‚Œã®ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ•ãƒƒã‚¯ã«ã¤ã„ã¦åˆ¥ã€…ã«èª¬æ˜ã—ã¾ã™ã€‚

## æ›´æ–°æ™‚ã®ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ï¼ˆåˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã¯ãªã„ï¼‰å ´åˆã€å„ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ•ãƒƒã‚¯å‘¼ã³å‡ºã—ã¯ä»¥ä¸‹ã®å¼ã§å§‹ã¾ã‚Šã€ãã®å¾Œã«ç‰¹å®šã®å‡¦ç†ãŒç¶šãã¾ã™ã€‚

```tsx
const hook = updateWorkInProgressHook();
```

[`updateWorkInProgressHook`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L973)
ã¯ãƒã‚¦ãƒ³ãƒˆã‚ˆã‚Šã‚‚è¤‡é›‘ã§ã™ãŒã€ç›®çš„ã¯æ¬¡ã®`workInProgressHook`ã‚’æ¤œå‡ºã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯æ›´æ–°ã¨å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ä¸¡æ–¹ã«ä½¿ç”¨ã•ã‚Œã€å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‹ã‚‰`current`ãƒ•ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã‹ã€`work-in-progress`ã‚’å†åˆ©ç”¨ã™ã‚‹ã‹ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

ã“ã®é–¢æ•°ã®æœ€åˆã®éƒ¨åˆ†ã§ã¯ã€ç¾åœ¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ•ãƒƒã‚¯ã®å€¤ã‚’æ¤œå‡ºã—ã¾ã™ã€‚`currentHook`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ•°ãŒ null ã®å ´åˆã€`current`ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒãƒ¼ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€ãã®`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—ã—ã¾ã™ï¼š

```tsx
// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ï¼š
let currentHook: null | Hook = null;

// updateWorkInProgressHookå†…ã§ï¼š

let nextCurrentHook: null | Hook;
if (currentHook === null) {
  // ç¾åœ¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒãƒ¼
  const current = currentlyRenderingFiber.alternate;

  // ã™ã§ã«ãƒã‚¦ãƒ³ãƒˆæ¸ˆã¿ã®å ´åˆ
  if (current !== null) {
    nextCurrentHook = current.memoizedState;
  } else {
    // åˆå›ãƒã‚¦ãƒ³ãƒˆã®å ´åˆ
    nextCurrentHook = null;
  }
} else {
  nextCurrentHook = currentHook.next;
}
```

ã“ã‚Œã§ã€ç¾åœ¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¸ˆã¿ï¼ˆãƒšã‚¤ãƒ³ãƒˆæ¸ˆã¿ï¼‰ãƒ•ãƒƒã‚¯ã®å€¤ã‚’æ¤œå‡ºã—ãŸã®ã§ã€React ã¯æ¬¡ã«ãã®ä»£æ›¿ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®ã‚‚ã®ï¼‰ã‚’æ¤œå‡ºã—ã¾ã™ï¼š

```tsx
// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ï¼š
let workInProgressHook: null | Hook = null;

// updateWorkInProgressHookå†…ã§ï¼š
let nextWorkInProgressHook: null | Hook;

// ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ•ãƒƒã‚¯ã®å ´åˆã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒãƒ¼ã‹ã‚‰å–å¾—
if (workInProgressHook === null) {
  nextWorkInProgressHook = currentlyRenderingFiber.memoizedState;
} else {
  // ãã‚Œä»¥å¤–ã®å ´åˆã€æ¬¡ã®ãƒ•ãƒƒã‚¯
  nextWorkInProgressHook = workInProgressHook.next;
}
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹éš›ã€memoizedState ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã€null ã«è¨­å®šã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã§ã€ç¾åœ¨ã®ãƒšã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒƒã‚¯ã®å€¤ã¨ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®ã‚‚ã®ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

`nextWorkInProgressHook`ãŒã‚ã‚‹å ´åˆã€ã“ã‚Œã¯ã™ã§ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã—ã¦ã„ã¦ã€ã‚³ãƒŸãƒƒãƒˆã‚„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®çµ‚äº†ãªã—ã«å†åº¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã€ãã®ã¾ã¾å†åˆ©ç”¨ã—ã¾ã™ï¼š

```tsx
if (nextWorkInProgressHook !== null) {
  // ã™ã§ã«ãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚å†åˆ©ç”¨ã—ã¾ã™ã€‚
  workInProgressHook = nextWorkInProgressHook;
  nextWorkInProgressHook = workInProgressHook.next;

  currentHook = nextCurrentHook;
}
```

ãã‚Œä»¥å¤–ã®å ´åˆã€`nextCurrentHook`ãŒ null ã®å ´åˆã€å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚ˆã‚Šã‚‚ãƒ•ãƒƒã‚¯ã‚’å¤šããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã€ãƒ•ãƒƒã‚¯ã®è¦å‰‡ã«åã™ã‚‹ã“ã¨ã«ãªã‚Šã€React ã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚
`nextCurrentHook`ãŒ null ã§ãªã„å ´åˆã€å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ãƒ•ãƒƒã‚¯ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦åŸºã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```tsx
// Reactã®ã‚³ãƒ¼ãƒ‰

if (nextWorkInProgressHook !== null) {
  // å‰ã®ã‚³ãƒ¼ãƒ‰
} else {
  if (nextCurrentHook === null) {
    const currentFiber = currentlyRenderingFiber.alternate;
    if (currentFiber === null) {
      // ã“ã‚Œã¯åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã™ã€‚ã“ã®ãƒ–ãƒ©ãƒ³ãƒã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä¸€æ™‚åœæ­¢ã—ã€å†é–‹ã—ã¦ã‹ã‚‰è¿½åŠ ã®ãƒ•ãƒƒã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¨ãã«åˆ°é”ã—ã¾ã™ã€‚
      // ã“ã®ãƒ–ãƒ©ãƒ³ãƒã«åˆ°é”ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã«ãƒã‚¦ãƒ³ãƒˆãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      throw new Error(
        "Update hook called on initial render. This is likely a bug in React. Please file an issue."
      );
    } else {
      // ã“ã‚Œã¯æ›´æ–°ã§ã™ã€‚å¸¸ã«ç¾åœ¨ã®ãƒ•ãƒƒã‚¯ãŒã‚ã‚‹ã¯ãšã§ã™ã€‚
      throw new Error("Rendered more hooks than during the previous render.");
    }
  }

  currentHook = nextCurrentHook;

  // ç¾åœ¨ã®ãƒšã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒƒã‚¯ã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³
  const newHook: Hook = {
    memoizedState: currentHook.memoizedState,

    baseState: currentHook.baseState,
    baseQueue: currentHook.baseQueue,
    queue: currentHook.queue,

    next: null,
  };

  if (workInProgressHook === null) {
    // ã“ã‚Œã¯ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ•ãƒƒã‚¯ã§ã™ã€‚
    currentlyRenderingFiber.memoizedState = workInProgressHook = newHook;
  } else {
    // ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¿½åŠ 
    workInProgressHook = workInProgressHook.next = newHook;
  }
}
```

## å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã„ã†ç”¨èªã¯ã€React ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å†…ã§ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ãŸã‹ã€é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

`HooksDispatcherOnRerender`ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã‚’è¦‹ã‚‹ã¨ã€`useReducer: rerenderReducer`, `useState: rerenderState`, `useDeferredValue: rerenderDeferredValue`, `useTransition: rerenderTransition`ä»¥å¤–ã¯`HooksDispatcherOnUpdate`ã¨åŒã˜ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã“ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã¯[`renderWithHooksAgain`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L771)é–¢æ•°ã‹ã‚‰è¨­å®šã•ã‚Œã¾ã™ã€‚Andrew ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ï¼š

```tsx
// ã“ã‚Œã¯åˆ¥ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‘ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã€ã¾ãŸã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§2å›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ãã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
//
// å‰å›ã®ãƒ‘ã‚¹ã®çŠ¶æ…‹ã¯å¯èƒ½ãªé™ã‚Šå†åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ã™ã§ã«å‡¦ç†ã•ã‚ŒãŸçŠ¶æ…‹æ›´æ–°ã¯å†åº¦å‡¦ç†ã•ã‚Œãšã€ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸé–¢æ•°ï¼ˆ`useMemo`ï¼‰ã¯å†åº¦å‘¼ã³å‡ºã•ã‚Œã¾ã›ã‚“ã€‚
//
// ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œç¶šã‘ã‚‹é™ã‚Šã€ãƒ«ãƒ¼ãƒ—ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç¶šã‘ã¾ã™ã€‚ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```

## å„ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã®å­˜åœ¨é †ã«å¾“ã£ã¦ã€å„ãƒ•ãƒƒã‚¯ã‚’èª¬æ˜ã—ã¾ã™ã€‚

import TBD from "./components/TBDBanner"

## `use`ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

`use`ãƒ•ãƒƒã‚¯ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã£ã¦ã„ã‚‹é–“ã«ã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹`throw promise`ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç½®ãæ›ãˆã‚‹æ–°ã—ã„ãƒ•ãƒƒã‚¯ã§ã™ã€‚

`throw promise`ã¯é•·ãã‹ã‚‰å­˜åœ¨ã—ã¦ã„ã¾ã—ãŸãŒã€å…¬å¼ã§ã¯ãªãã€ã“ã®ãƒ•ãƒƒã‚¯ã¯å…¬å¼ã®ä»£æ›¿ã¨ã—ã¦å°å…¥ã•ã‚Œã¾ã—ãŸã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`use`ãƒ•ãƒƒã‚¯ã¯[ã“ã“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L1093)ã€‚

```tsx
function use<T>(usable: Usable<T>): T {
  // [Not Native Code]
}
```

Promise ã¾ãŸã¯ Context å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

:::tip
`use`ãƒ•ãƒƒã‚¯ã¯`mountWorkInProgressHook`ã¨`updateWIPHook`ã«ä¾å­˜ã—ãªã„ãŸã‚ã€æ¡ä»¶ä»˜ãã§å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã€ãƒ•ãƒƒã‚¯ã®è¦å‰‡ã«å¾“ã‚ãªããªã‚Šã¾ã™ã€‚
:::

### å®Ÿè£…

å‰è¿°ã®ã‚ˆã†ã«ã€`use`ã¯`thenabled`ã¨`Context`ã®ä¸¡æ–¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ï¼š

#### Context

`use`ã«æ¸¡ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ React ã®`Context`ã§ã‚ã‚‹å ´åˆã€`readContext`é–¢æ•°ã«å‡¦ç†ã‚’å§”è­²ã—ã¾ã™ã€‚ã“ã‚Œã¯`useContext`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ã¾ã™ã€‚

```tsx
if (
  usable.$$typeof === REACT_CONTEXT_TYPE ||
  usable.$$typeof === REACT_SERVER_CONTEXT_TYPE
) {
  const context: ReactContext<T> = usable;
  return readContext(context);
}
```

ãã®ãŸã‚ã€`use`ã‚’ä½¿ç”¨ã™ã‚‹ã¨æ¡ä»¶ä»˜ãã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã§ãã€ãƒ•ãƒƒã‚¯ã®è¦å‰‡ã‚’å›é¿ã§ãã¾ã™ ğŸ¤¯

#### Thenable

Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæä¾›ã•ã‚ŒãŸå ´åˆã€React ã¯[å†…éƒ¨ã®`useThenable`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L1066)é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š

```tsx
function use<T>(usable: Usable<T>): T {
  if (usable !== null && typeof usable === "object") {
    if (typeof usable.then === "function") {
      const thenable: Thenable<T> = usable;
      return useThenable(thenable);
    }
    // ... other code
  }

  throw new Error("An unsupported type was passed to use(): " + String(usable));
}
```

`useThenable`é–¢æ•°ãŒ`use`ãƒ•ãƒƒã‚¯ã®ä»•äº‹ã®èƒŒå¾Œã«ã‚ã‚‹ã“ã¨ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚

åˆæœŸåŒ–ã¨ thenable çŠ¶æ…‹ã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆã“ã‚Œã«ã¤ã„ã¦ã¯èª¬æ˜ã—ã¾ã›ã‚“ï¼‰ã®å¾Œã€`useThenable`ã¯[`trackUsedThenable`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberThenable.js#L69)ã‚’å‘¼ã³å‡ºã—ã€ã“ã‚ŒãŒã™ã¹ã¦ã®ä»•äº‹ã‚’è¡Œã„ã¾ã™ã€‚

```tsx
function useThenable<T>(thenable: Thenable<T>): T {
  // ã“ã®ãƒ•ã‚¡ã‚¤ãƒãƒ¼å†…ã§thenableã®ä½ç½®ã‚’è¿½è·¡ã—ã¾ã™ã€‚
  const index = thenableIndexCounter;
  thenableIndexCounter += 1;
  if (thenableState === null) {
    // createThenableStateã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãªJavaScripté…åˆ—ã‚’è¿”ã—ã¾ã™
    thenableState = createThenableState();
  }
  // highlight-next-line
  const result = trackUsedThenable(thenableState, thenable, index);
  // ... other code
  return result;
}
```

ãã‚Œã§ã¯`trackUsedThenable`ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ï¼š

1. ãƒ‘ãƒ¼ãƒˆ 1ï¼šthenable ã‚’é…åˆ—ã«è¿½åŠ ã™ã‚‹

   ã‚½ãƒ•ã‚£ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚åŒã˜ä½ç½®ã« thenable ãŒã‚ã£ãŸå ´åˆã€æŠ€è¡“çš„ã«ã¯åŒã˜å€¤ã‚’æŒ‡ã™ã¯ãšã§ã™ã®ã§ã€å‰è€…ã‚’å†åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã®è¨­è¨ˆé¸æŠã«ã¤ã„ã¦èã‹ã‚ŒãŸã‚‰ç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚

   ```tsx
   const previous = thenableState[index];
   if (previous === undefined) {
     thenableState.push(thenable);
   } else {
     if (previous !== thenable) {
       // å‰ã®thenableã‚’å†åˆ©ç”¨ã—ã€æ–°ã—ã„ã‚‚ã®ã‚’æ¨ã¦ã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯æ’ç­‰ã§ã‚ã‚‹ã¨ä»®å®šã§ãã¾ã™ã€‚

       // æ„å›³çš„ã«ç„¡è¦–ã™ã‚‹Promiseã®æœªå‡¦ç†ã®æ‹’å¦ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€ãã‚Œã‚‰ã‚’å‡¦ç†ã—ã¾ã™ã€‚
       thenable.then(noop, noop);
       thenable = previous;
     }
   }
   ```

2. ãƒ‘ãƒ¼ãƒˆ 2ï¼šthenable ã‚’è¿½è·¡ã™ã‚‹
   å‰ã« thenable ã‚’è¿½è·¡ã—ãŸã“ã¨ãŒã‚ã‚‹ã‹ã€åˆã‚ã¦é­é‡ã—ãŸã‹ã«ã‚ˆã£ã¦ã€2 ã¤ã®ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

   thenable ã‚’è¿½è·¡ã™ã‚‹ã“ã¨ã¯ã€thenable è‡ªä½“ã‚’å¤‰æ›´ã™ã‚‹`then(onFullfilement, onRejection)`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼š

   ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚ˆãèª­ã‚“ã§ç†è§£ã—ã¦ãã ã•ã„ï¼š

   ```tsx
   const pendingThenable: PendingThenable<T> = thenable;
   pendingThenable.status = "pending";
   pendingThenable.then(
     (fulfilledValue) => {
       if (thenable.status === "pending") {
         const fulfilledThenable: FulfilledThenable<T> = thenable;
         fulfilledThenable.status = "fulfilled";
         fulfilledThenable.value = fulfilledValue;
       }
     },
     (error: mixed) => {
       if (thenable.status === "pending") {
         const rejectedThenable: RejectedThenable<T> = thenable;
         rejectedThenable.status = "rejected";
         rejectedThenable.reason = error;
       }
     }
   );
   ```

   ã—ã‹ã—ã€thenable ãŒæ—¢ã«è¿½è·¡ã•ã‚Œã¦ã„ã‚‹å ´åˆã€å˜ã«ãã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ï¼š

   ```tsx
   switch (thenable.status) {
     case "fulfilled": {
       const fulfilledValue: T = thenable.value;
       return fulfilledValue;
     }
     case "rejected": {
       const rejectedError = thenable.reason;
       checkIfUseWrappedInAsyncCatch(rejectedError);
       throw rejectedError;
     }
     // ... other code
   }
   ```

   - çŠ¶æ…‹ãŒ`fulfilled`ã®å ´åˆã€`use`ãƒ•ãƒƒã‚¯ã¯å€¤ã‚’è¿”ã—ã¾ã™
   - çŠ¶æ…‹ãŒ`rejected`ã®å ´åˆã€`use`ãƒ•ãƒƒã‚¯ã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™

   çŠ¶æ…‹ãŒ`pending`ã®å ´åˆã€React ã¯ç‰¹åˆ¥ãªä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹`SuspenseException`ã‚’ã‚¹ãƒ­ãƒ¼ã—ã€thenable ãŒè§£æ±ºã¾ãŸã¯æ‹’å¦ã•ã‚Œã‚‹ã¾ã§ãƒ„ãƒªãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚

   ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã«ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚

   :::note
   `use`ãƒ•ãƒƒã‚¯ã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã™ã‚‹ãŸã‚ã«ãƒ„ãƒªãƒ¼ã«ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
   :::

:::warning
`use`ãƒ•ãƒƒã‚¯ã¯ã€æ‰‹å‹•ã§ãƒ—ãƒ­ãƒŸã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ãƒ¡ãƒ¢åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`React.cache`å®Ÿé¨“çš„ãª API ã¯ã€ã“ã‚Œã‚’åŠ©ã‘ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
:::

### ä¾‹

jsonplaceholder ã®å…¬é–‹ API ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€å˜ç´”ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã—ã¦ã€ãƒ—ãƒ­ãƒŸã‚¹ã‚’ãƒ¡ãƒ¢åŒ–ã—ã€ç„¡é™ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é¿ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã“ã§ã€é–¢æ•°ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ¡ãƒ¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ï¼š

```tsx
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¯1ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã¨ä»®å®šã—ã¾ã™
// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™ã€‚
// React.cacheã¯ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ä¸€èˆ¬çš„ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
// æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€userIdã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™
function createCache(asyncFunc) {
  let cache = {};

  return function exec(...args) {
    let cacheId = args[0];
    let existing = cache[cacheId];
    if (existing) {
      return existing;
    }

    let result = asyncFunc.apply(null, args);
    cache[cacheId] = result;
    return result;
  };
}
```

æ¬¡ã«ã€ãƒ€ãƒŸãƒ¼ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªã‚’ä½œæˆã—ã¾ã™ï¼š

```tsx
class ErrorBoundary extends React.Component {
  state = { error: null };
  componentDidCatch(error) {
    this.setState((prev) => ({ ...prev, error }));
  }
  render() {
    const { error } = this.state;
    if (error) {
      return (
        <>
          <pre>{error.toString()}</pre>
          <button
            onClick={() => this.setState((prev) => ({ ...prev, error: null }))}
          >
            Reset
          </button>
        </>
      );
    }
    return this.props.children;
  }
}
```

æœ€å¾Œã«ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ã¾ã™ï¼š

```tsx
async function fetchUserById(userId) {
  let result = await axios.get(
    `https://jsonplaceholder.typicode.com/users/${userId}`
  );
  return result.data;
}

let getUserDetails = createCache(fetchUserById);

let IDS = [1, 2, 3, 4, 5, 10, 11];

function UserDetails({ id }) {
  let details = React.use(getUserDetails(id));

  return (
    <details open>
      <pre>{JSON.stringify(details, null, 4)}</pre>
    </details>
  );
}
function Example() {
  let [userId, setUserId] = React.useState(IDS[0]);
  return (
    <div className="App">
      {IDS.map((id) => (
        <button
          onClick={() => {
            setUserId(id);
          }}
          key={id}
        >
          {`User ${id}`}
        </button>
      ))}
      <React.Suspense fallback={`Loading user ${userId}`}>
        <UserDetails id={userId} />
      </React.Suspense>
    </div>
  );
}

export default function App() {
  return (
    <ErrorBoundary>
      <Example />
    </ErrorBoundary>
  );
}
```

ã“ã®[ãƒ‡ãƒ¢](https://codesandbox.io/s/lucid-curran-x8xxlj?file=/src/App.js)ã‚’è¡¨ç¤ºã—ã¦æ“ä½œã§ãã¾ã™ï¼š

<iframe src="https://codesandbox.io/embed/lucid-curran-x8xxlj?fontsize=14&hidenavigation=1&theme=dark"
style={{width: "100%", height: "500px", border: 0, borderRadius: 4}}
title="React.use demo"
allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>

## `useCallback`ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

`useCallback`ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¾ã§é–¢æ•°å‚ç…§ã‚’ä¿æŒã§ãã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`useCallback`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

```tsx
function useCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // [Not Native Code]
}
```

ç›´æ¥çš„ã«ã¯å­˜åœ¨ã—ãªã„é–¢æ•°ã§ã™ãŒã€å‰è¿°ã®ã‚ˆã†ã«[`mountCallback`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2602)ã¨[`updateCallback`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2609)é–¢æ•°ãŒã‚ã‚Šã€åŒã˜ã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã¡ã¾ã™ï¼š

```tsx
function mountCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // [Not Native Code]
}
function updateCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // [Not Native Code]
}
```

### å®Ÿè£…

#### ãƒã‚¦ãƒ³ãƒˆæ™‚

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæœ€åˆã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ãã«`useCallback`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å‘¼ã³å‡ºã—ã¯`mountCallback`ã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã•ã‚Œã€æœ€ã‚‚ç°¡å˜ãªãƒ•ãƒƒã‚¯ã§ã™ï¼š

```tsx
function mountCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const nextDeps = deps === undefined ? null : deps;
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  hook.memoizedState = [callback, nextDeps];
  return callback;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**ï¼šå‰è¿°ã®ãƒ•ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 2**ï¼šä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã¯`null`ã‚’ä½¿ç”¨ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 3**ï¼šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ä¾å­˜é–¢ä¿‚ã‚’ãƒ•ãƒƒã‚¯ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ ¼ç´ã—ã¾ã™

`useCallback`ã¯æ¸¡ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚é€šå¸¸ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã‚’ç›´æ¥å®šç¾©ã™ã‚‹ã‹ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæœ¬ä½“å†…ã§å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã‚’æ¸¡ã—ã¾ã™ã€‚

ãƒã‚¦ãƒ³ãƒˆæ™‚ã«`useCallback`ã¯ä¾å­˜é–¢ä¿‚ã«ã¤ã„ã¦ã¯é–¢å¿ƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å˜ã«ãã‚Œã‚‰ã‚’å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«æ ¼ç´ã™ã‚‹ã ã‘ã§ã™ã€‚

#### æ›´æ–°æ™‚

æ›´æ–°æ™‚ã€ç›®çš„ã¯ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã®ã¿æ–°ã—ã„é–¢æ•°å‚ç…§ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã™ã€‚

```tsx
function updateCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = updateWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const nextDeps = deps === undefined ? null : deps;
  const prevState = hook.memoizedState;
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  if (nextDeps !== null) {
    const prevDeps: Array<mixed> | null = prevState[1];
    // ã‚¹ãƒ†ãƒƒãƒ—4
    // highlight-next-line
    if (areHookInputsEqual(nextDeps, prevDeps)) {
      return prevState[0];
    }
  }
  // ã‚¹ãƒ†ãƒƒãƒ—5
  // highlight-next-line
  hook.memoizedState = [callback, nextDeps];
  return callback;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**ï¼šãƒ•ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã¾ãŸã¯å†åˆ©ç”¨ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 2**ï¼šä¾å­˜é–¢ä¿‚é…åˆ—ã‚’æ¨è«–ã—ã¾ã™ã€‚æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯`null`ã‚’ä½¿ç”¨ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 3**ï¼šä¾å­˜é–¢ä¿‚ãŒ null ã§ãªã„å ´åˆï¼ˆundefined ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒ¡ãƒ¢åŒ–ã—ãªã„ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼‰ã€å‰ã®ä¾å­˜é–¢ä¿‚ã¨æ¯”è¼ƒã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 4**ï¼šå‰ã®ä¾å­˜é–¢ä¿‚ã¨æ¬¡ã®ä¾å­˜é–¢ä¿‚ã‚’æ¯”è¼ƒã—ã€åŒã˜å ´åˆã¯å‰ã®å€¤ï¼ˆ`memoizedState`é…åˆ—ã®æœ€åˆã®è¦ç´ ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚æ¯”è¼ƒæ–¹æ³•ã¯å¾Œã§èª¬æ˜ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 5**ï¼šä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã€ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ãªã„å ´åˆã€`mountCallback`ã¨åŒæ§˜ã«`[callback, nextDeps]`ã‚’ãƒ•ãƒƒã‚¯ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ ¼ç´ã—ã¾ã™

The [`areHookInputsEqual`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L451)
é–¢æ•°ã¯ä¾å­˜é…åˆ—ã‚’ä½¿ç”¨ã™ã‚‹ã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ï¼š

- å‰å›ã®ä¾å­˜é…åˆ—ãŒãªã„å ´åˆã€å¸¸ã«`false`ã‚’è¿”ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š React ã¯ãƒ•ãƒƒã‚¯ã®è¿”ã‚Šå€¤ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ä¾å­˜é…åˆ—ãŒç©ºï¼ˆ`[]`ï¼‰ã®å ´åˆã€æ¯å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ›´æ–°ã•ã‚Œã¾ã™
- ä¸¡æ–¹ã®é…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€`Object.is`ã§å€‹ã€…ã®å€¤ã‚’æ¯”è¼ƒã—ã¾ã™

## useContext ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

[`useContext`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useContext)ã¯[React Context](https://medium.com/@mohamedelayadi/react-context-all-you-need-to-know-40de6662b074)ã®å€¤ã‚’èª­ã¿å–ã‚Šã€å¤‰æ›´ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

[`useContext`ãƒ•ãƒƒã‚¯](https://github.com/facebook/react/blob/540bab085d571789f4562565eebfd0db9f36345c/packages/react-reconciler/src/ReactFiberNewContext.js#L713)ã¯æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function readContext<T>(context: ReactContext<T>): T {
  // [Not Native Code]
}
```

ã“ã“ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯[`React.createContext` API](https://react.dev/reference/react/createContext)ã§ä½œæˆã•ã‚ŒãŸ React Context ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã—ã¾ã™ã€‚

### å®Ÿè£…

`useContext`ã¯[`readContextForConsumer`](https://github.com/facebook/react/blob/540bab085d571789f4562565eebfd0db9f36345c/packages/react-reconciler/src/ReactFiberNewContext.js#L740)é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```tsx
export function readContext<T>(context: ReactContext<T>): T {
  // ...é–‹ç™ºç’°å¢ƒç”¨ã®ãƒã‚§ãƒƒã‚¯
  return readContextForConsumer(currentlyRenderingFiber, context);
}
```

`readContextForConsumer`é–¢æ•°ã¯ç¾åœ¨ã® Context å€¤ã‚’å–å¾—ã—ã€å°†æ¥ã®å¤‰æ›´ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å®Ÿè£…ã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼š

```tsx
function readContextForConsumer<T>(
  consumer: Fiber | null,
  context: ReactContext<T>
): T {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const value = isPrimaryRenderer
    ? context._currentValue
    : context._currentValue2;

  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  if (lastFullyObservedContext === context) {
    // æ—¢ã«ã“ã®Contextã‚’å®Œå…¨ã«ç›£è¦–ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    // ã‚¹ãƒ†ãƒƒãƒ—3
    // highlight-next-line
  } else {
  }
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: `isPrimaryRenderer`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«åŸºã¥ã„ã¦å†…éƒ¨ã® Context å€¤ã‚’æ±ºå®šã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã‚«ã‚¹ã‚¿ãƒ  React ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆæ™‚ã«è¨­å®šã•ã‚Œã¾ã™ã€‚Primary ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã¯ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒ¼ã—ã€Secondary ã¯ä»–ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ä¸Šã§ä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚React-DOM ã®å ´åˆã€Primary ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã¨ã—ã¦å‹•ä½œã™ã‚‹ãŸã‚`_currentValue`ã‚’ä½¿ç”¨ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: `lastFullyObservedContext`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ Context ã®ç›£è¦–çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã®å¤‰æ•°ã¯[ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å…¨ä½“ã§æœªä½¿ç”¨](https://github.com/search?q=repo%3Afacebook%2Freact%20lastFullyObservedContext&type=code)ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: å®Ÿéš›ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹éƒ¨åˆ†ï¼ˆå¾Œè¿°ï¼‰

### Context ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿

Context ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯`fiber.dependencies`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼š

```tsx
// ç°¡ç•¥åŒ–ç‰ˆ
function readContextForConsumer<T>(
  consumer: Fiber | null,
  context: ReactContext<T>
): T {
  const value = context._currentValue;

  const contextItem = {
    context: context as ReactContext<any>,
    memoizedValue: value,
    next: null,
  };
}
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åˆã‚ã¦`useContext`ãŒå‘¼ã°ã‚Œã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`dependencies`ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ï¼š

```tsx
// ç°¡ç•¥åŒ–ç‰ˆ

// updateFunctionComponentãªã©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°æ™‚ã«
// prepareToReadContexté–¢æ•°ã§lastContextDependencyå¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
if (lastContextDependency === null) {
  lastContextDependency = contextItem;
  // consumerã¯ç¾åœ¨å‡¦ç†ä¸­ã®fiber
  consumer.dependencies = {
    lanes: NoLanes,
    firstContext: contextItem,
  };
}
```

æ—¢å­˜ã®ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã€context ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã—ã¾ã™ï¼š

```tsx
if (lastContextDependency === null) {
  // ...
} else {
  lastContextDependency = lastContextDependency.next = contextItem;
}
```

And that's it!

### æ›´æ–°å‡¦ç†

`ContextProvider`ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€React ã¯`value`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€å¤‰æ›´ã‚’ä¼æ’­ã—ã¾ã™ã€‚

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°ã¯ã€`ContextProvider`ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ä»•çµ„ã¿ã§èª¬æ˜ã•ã‚Œã¾ã™ã€‚

:::note
`use`ãƒ•ãƒƒã‚¯ã¨åŒæ§˜ã«ã€`useContext`ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«æ¡ä»¶ä»˜ãã§å‘¼ã³å‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ãŸã ã—ã€ä»–ã®ãƒ•ãƒƒã‚¯å†…ã‚„ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºå¤–ã§å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ç¾åœ¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã® fiber ãŒå¿…è¦ãªãŸã‚ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ããªã„ã‹ã‚‰ã§ã™ã€‚
:::

## useEffect ãƒ•ãƒƒã‚¯ã®ä»•çµ„ã¿

[`useEffect`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useEffect)ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« passive effects ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

Passive effects ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ã® commit ãƒ•ã‚§ãƒ¼ã‚ºã®æœ€å¾Œã®éƒ¨åˆ†ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚`SyncLane`ã®å ´åˆã¯åŒæœŸçš„ã«ã€ãã®ä»–ã® lane ã®å ´åˆã¯éåŒæœŸã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šï¼š

> useEffect ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨åŒæœŸã•ã›ã‚‹ React ãƒ•ãƒƒã‚¯ã§ã™

ã“ã‚Œã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ APIï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã€ãƒªã‚µã‚¤ã‚ºã€ãƒ–ãƒ©ãƒ¼ãªã©ï¼‰ã‚„å¤–éƒ¨ã‚¹ãƒˆã‚¢ã¨ã®åŒæœŸã«ã®ã¿ä½¿ç”¨ã™ã¹ãã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`useEffect`ãƒ•ãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  // [Not Native Code]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š

- `create`: effect ä½œæˆé–¢æ•°ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‰ãšã€ä½•ã‚‚è¿”ã•ãªã„ã‹`cleanup`é–¢æ•°ã‚’è¿”ã—ã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®è³¼èª­è§£é™¤ãªã©ã€effect ã®å¾Œå‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚
- `deps`: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä¾å­˜é…åˆ—ã€‚ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã« effect ã®ä½œæˆãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€effect ã¯**ã™ã¹ã¦ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®çµ‚äº†æ™‚ã«å®Ÿè¡Œ**ã•ã‚Œã¾ã™ã€‚

:::note
ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºä¸­ã«çŠ¶æ…‹æ›´æ–°ãŒç™ºç”Ÿã—ã¦ã‚‚ã€effect ã¯ 2 å›å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚effect ã¯ commit ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
:::

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

é€šå¸¸ã®ãƒ•ãƒƒã‚¯ã¨åŒæ§˜ã€`mountWorkInProgressHook()`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`mountEffect`ã¯`mountEffectImpl`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

:::note
`mountEffectImpl`ã¯ä»–ã® effect ãƒ•ãƒƒã‚¯ï¼ˆuseLayoutEffectã€useInsertionEffect ãªã©ï¼‰ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
:::

```tsx
function mountEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  mountEffectImpl(
    PassiveEffect | PassiveStaticEffect,
    HookPassive,
    create,
    deps
  );
}
```

`mountEffectImpl`ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

```tsx
function mountEffectImpl(
  fiberFlags: Flags,
  hookFlags: HookFlags,
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  // [Not Native Code]
}
```

- `fiberFlags`: effect ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹ãƒ•ãƒ©ã‚°
- `hookFlags`: [effect è‡ªä½“ã‚’å®šç¾©ã™ã‚‹ãƒ•ãƒ©ã‚°](https://github.com/facebook/react/blob/9cdf8a99edcfd94d7420835ea663edca04237527/packages/react-reconciler/src/ReactHookEffectTags.js#L10)ã€‚å¯èƒ½ãªå€¤ã¯`Insertion`ã€`Layout`ã€`Passive`ã€‚`useEffect`ã§ã¯`Passive`ãŒä½¿ç”¨ã•ã‚Œã¾ã™
- `create`: effect é–¢æ•°
- `deps`: effect ã®ä¾å­˜é–¢ä¿‚

`mountEffectImpl`é–¢æ•°ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```tsx
function mountEffectImpl(
  fiberFlags: Flags,
  hookFlags: HookFlags,
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const nextDeps = deps === undefined ? null : deps;
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  currentlyRenderingFiber.flags |= fiberFlags;
  // ã‚¹ãƒ†ãƒƒãƒ—4
  // highlight-next-line
  hook.memoizedState = pushEffect(
    HookHasEffect | hookFlags,
    create,
    createEffectInstance(),
    nextDeps
  );
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: ãƒ•ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã¯`null`ã‚’ä½¿ç”¨ã—ã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: å—ã‘å–ã£ãŸ fiberFlags ã‚’ç¾åœ¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã® fiber ã«è¿½åŠ ã—ã¾ã™ã€‚`useEffect`ã®å ´åˆã€`PassiveEffect | PassiveStaticEffect`ï¼ˆåŸ·ç­†æ™‚ç‚¹ã§ã¯è‡ªç„¶æ•°`8390656`ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 4**: ãƒ•ãƒƒã‚¯ã®`memoizedState`å€¤ã¨ã—ã¦`pushEffect`ã®çµæœã‚’ä¿å­˜ã—ã¾ã™

[`createEffectInstance`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2236)ã¯`{ destroy: undefined }`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯ effect ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™

æœ€å¾Œã«[`pushEffect`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2202)ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```tsx
function pushEffect(
  tag: HookFlags, // useEffect: Passive
  create: () => (() => void) | void,
  inst: EffectInstance, // { destroy: undefined }
  deps: Array<mixed> | null
): Effect {
  // [Not Native Code]
}
```

#### effect ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ã”ã¨ã«å„ effect ç”¨ã«ä½œæˆã•ã‚Œã€å¿…è¦ãªæƒ…å ±ã‚’ä¿æŒã—ã¾ã™ï¼š

```tsx
const effect: Effect = {
  tag, // ãƒ•ãƒƒã‚¯ãƒ•ãƒ©ã‚°
  create, // æä¾›ã•ã‚ŒãŸeffecté–¢æ•°
  inst, // { destroy: undefined }
  deps, // ä¾å­˜é–¢ä¿‚ã¾ãŸã¯null
  // å¾ªç’°å‚ç…§
  next: null, // å¾Œã§è¨­å®šã•ã‚Œã¾ã™
};
```

#### effect ã‚’é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® update queue ã«ãƒªãƒ³ã‚¯

æ¬¡ã«ã€React ã¯`currentlyRenderingFiber.updateQueue`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‚ç…§ã—ã¾ã™ã€‚null ã®å ´åˆã€åˆæœŸåŒ–ã—ã¾ã™ï¼š

```tsx
let componentUpdateQueue: null | FunctionComponentUpdateQueue =
  currentlyRenderingFiber.updateQueue;
if (componentUpdateQueue === null) {
  componentUpdateQueue = createFunctionComponentUpdateQueue();
  currentlyRenderingFiber.updateQueue = componentUpdateQueue;
  // å¾ªç’°å‚ç…§ã‚’ä½œæˆï¼ˆã‚³ãƒŸãƒƒãƒˆæ™‚ã«åˆ†è§£ã•ã‚Œã¾ã™ï¼‰
  componentUpdateQueue.lastEffect = effect.next = effect;
}
```

`createFunctionComponentUpdateQueue`ã§ä½œæˆã•ã‚Œã‚‹ update queue ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```tsx
const updateQueue = {
  lastEffect: null,
  events: null,
  stores: null,
};

// memoCacheæ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆã€nullã§åˆæœŸåŒ–ã•ã‚ŒãŸmemoCacheãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚Œã¾ã™
```

ã“ã‚Œã¯å¾ªç’°ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚lastEffect ã‚’ä¿å­˜ã™ã‚‹ã¨ã€ãã®`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãƒªã‚¹ãƒˆã®æœ€åˆã® effect ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®`updateQueue`ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã“ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ä»¥å‰ã« effect ã‚’å‘¼ã³å‡ºã—ãŸã‹ã€ä»–ã®ãƒ•ãƒƒã‚¯ãŒåˆæœŸåŒ–ã—ãŸå ´åˆï¼‰ã€React ã¯`lastEffect`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—ã—ï¼š

- `null`ã®å ´åˆï¼ˆupdateQueue ãŒ effect ä»¥å¤–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚„ã‚¹ãƒˆã‚¢ã§åˆæœŸåŒ–ã•ã‚ŒãŸå¯èƒ½æ€§ã‚ã‚Šï¼‰ã€ä»¥å‰ã¨åŒã˜å‡¦ç†ã‚’è¡Œã„ã¾ã™ï¼š`effect`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨è‡ªèº«ã®å¾ªç’°å‚ç…§ã‚’ä½œæˆã—ã€ã‚­ãƒ¥ãƒ¼ã®`lastEffect`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ã—ã¾ã™ã€‚
  ```tsx
  const lastEffect = componentUpdateQueue.lastEffect;
  if (lastEffect === null) {
    componentUpdateQueue.lastEffect = effect.next = effect;
  } else {
    // æ¬¡ã®å‡¦ç†ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†
  }
  ```
- `null`ã§ãªã„å ´åˆã€ã“ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‘ã‚¹ã§ä»¥å‰ã« effect ãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ãŸã“ã¨ã‚’æ„å‘³ã—ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
  ```tsx
  const firstEffect = lastEffect.next;
  lastEffect.next = effect;
  effect.next = firstEffect;
  componentUpdateQueue.lastEffect = effect;
  ```
  æ··ä¹±ã—ãªã„ã‚ˆã†ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’åˆ†è§£ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
  - ã¾ãšãƒªã‚¹ãƒˆã®æœ€åˆã® effect ã‚’å‚ç…§ã—ã¾ã™ï¼ˆå¾ªç’°ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã®ãŸã‚ã€æœ€åˆã®è¦ç´ ã¯æœ€å¾Œã®è¦ç´ ã®`next`ã§ã™ï¼‰
  - æ–°ã—ã„ effect ã‚’å‰ã®`lastEffect`ã®`next`ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ï¼ˆã“ã‚ŒãŒæ–°ã—ã„æœ€å¾Œã®è¦ç´ ã«ãªã‚Šã¾ã™ï¼‰
  - æ–°ã—ã„ effectï¼ˆæ–°ã—ã„æœ€å¾Œã®è¦ç´ ï¼‰ã¯`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§`firstEffect`ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™
  - æœ€å¾Œã«ã€æ–°ã—ã„ effect ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®`updateQueue`ãƒªã‚¹ãƒˆã® lastEffect ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™

æœ€çµ‚çš„ã«ã€`pushEffect`é–¢æ•°ã¯æ–°ã—ãä½œæˆã•ã‚ŒãŸ effect ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã€`hook.memoizedState`ã«ä¿å­˜ã—ã¾ã™ã€‚

### Implementation on update

### æ›´æ–°æ™‚ã®å®Ÿè£…

æ›´æ–°æ™‚ã€`useEffect`ã¯`HooksDispatcherOnUpdate`ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã‹ã‚‰[`updateEffect`](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2407)ã‚’å‘¼ã³å‡ºã—ã€[`updateEffectImpl`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2348)ã«å§”è­²ã—ã¾ã™ã€‚

ã¾ãšã€`updatewWorkInProgressHook`é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

```tsx
function updateEffectImpl(
  fiberFlags: Flags, // useEffectã®å ´åˆPassiveEffect
  hookFlags: HookFlags, // useEffectã®å ´åˆHookPassive
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  // å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®effect
  const effect: Effect = hook.memoizedState;
  // å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®effectã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå†åˆ©ç”¨ã•ã‚Œã‚‹ï¼‰
  const inst = effect.inst;

  // currentHookã¯ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºå¾Œã®å†ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã‚„Strict Modeã§ã®åˆæœŸãƒã‚¦ãƒ³ãƒˆæ™‚ã«nullã«ãªã‚Šã¾ã™
  // updateWIPHookã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§currentHookã«ã¤ã„ã¦æ—¢ã«èª¬æ˜ã—ã¦ã„ã¾ã™
  if (currentHook !== null) {
    if (nextDeps !== null) {
      const prevEffect: Effect = currentHook.memoizedState;
      const prevDeps = prevEffect.deps;
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        // ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨åŒæ§˜ã®pushEffectã‚’å‘¼ã³å‡ºã—
        hook.memoizedState = pushEffect(hookFlags, create, inst, nextDeps);
        return;
      }
    }
  }

  // fiberãƒ•ãƒ©ã‚°ã«fiberFlagsã‚’è¿½åŠ 
  currentlyRenderingFiber.flags |= fiberFlags;
  hook.memoizedState = pushEffect(
    HookHasEffect | hookFlags,
    create,
    inst,
    nextDeps
  );
}
```

:::tip
ã“ã‚ŒãŒ useEffect ã®å‹•ä½œåŸç†ã§ã™ã€‚effect é–¢æ•°ã¯ commit ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã¯é–¢é€£æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ã ã‘ã§ã™ã€‚

å„ã‚¿ã‚¤ãƒ—ã® effect ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦è©³ã—ãã¯ã€[`how commit works`ã‚»ã‚¯ã‚·ãƒ§ãƒ³](/how-react-works/docs/react-dom/how.commit.works#how-commitroot-works)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

## How useImperativeHandle works

[`useImperativeHandle`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useImperativeHandle)ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

> useImperativeHandle ã¯ã€ref ã¨ã—ã¦å…¬é–‹ã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ React ãƒ•ãƒƒã‚¯ã§ã™

å…·ä½“çš„ã«ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå…¬é–‹ã™ã‚‹ refï¼ˆãƒãƒ³ãƒ‰ãƒ«ï¼‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³ã«`sayHiTo(name)`é–¢æ•°ã‚’è¿½åŠ ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹å ´åˆãªã©ã«ä½¿ç”¨ã—ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`useImperativeHandle`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function mountImperativeHandle<T>(
  ref: { current: T | null } | ((inst: T | null) => mixed) | null | void,
  create: () => T,
  deps: Array<mixed> | void | null
): void {
  // [Not Native Code]
}
```

- **ref**: `useRef`ã¾ãŸã¯`createRef`ã§ä½œæˆã•ã‚ŒãŸ ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯ ref ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **create**: æ–°ã—ã„ ref ãƒãƒ³ãƒ‰ãƒ«ã‚’è¿”ã™é–¢æ•°
- **deps**: ãƒ•ãƒƒã‚¯ã®ä¾å­˜é–¢ä¿‚ã€‚ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ create é–¢æ•°ãŒå†å‘¼ã³å‡ºã—ã•ã‚Œã¾ã™

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

`useImperativeHandle`ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆã‚ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ãã€[`mountImperativeHandle`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2533)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ï¼š

```tsx
// step 1
// highlight-next-line
const effectDeps =
  deps !== null && deps !== undefined ? deps.concat([ref]) : null;
// step 2
// highlight-next-line
mountEffectImpl(
  UpdateEffect | LayoutStaticEffect,
  HookLayout,
  imperativeHandleEffect.bind(null, create, ref),
  effectDeps
);
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: å®Ÿéš›ã®ãƒ•ãƒƒã‚¯ä¾å­˜é–¢ä¿‚ã‚’è¨ˆç®—ã—ã¾ã™ã€‚æä¾›ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã« ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’è¿½åŠ ã—ã¾ã™ã€‚ref ã‚’é…åˆ—ã«è¿½åŠ ã›ãšã€é–‹ç™ºè€…ãŒæ‰‹å‹•ã§è¿½åŠ ã™ã‚‹ã¹ãã¨ä»®å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€å¾Œæ–¹äº’æ›æ€§ãŒå¤±ã‚ã‚Œã¾ã™
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: 2 ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ effect ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ã™ï¼ˆé©šãã§ã™ã­ï¼ğŸ˜³ï¼‰

ãã®é€šã‚Šã§ã™ã€‚`useImperativeHandle`ã¯ç‰¹åˆ¥ãª layout effect ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚ã“ã® effect ã®`create`é–¢æ•°ã¯[`imperativeHandleEffect`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2503)ã§ã™

:::tip
ã‚³ãƒŸãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºä¸­ã€React ã¯`Layout`ãƒ•ã‚§ãƒ¼ã‚ºã§ ref ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ã“ã‚ŒãŒå…¨ä½“ã®å‡¦ç†ãŒ layout effect ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ç†ç”±ã§ã™
:::

### æ›´æ–°æ™‚ã®å®Ÿè£…

æ›´æ–°æ™‚ã€`useImperativeHandle`ã¯ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨åŒæ§˜ã«ä¾å­˜é–¢ä¿‚ã‚’è¨ˆç®—ã—ã€`UpdateEffect`ã‚’ fiber ãƒ•ãƒ©ã‚°ã¨ã—ã¦`updateEffectImpl`ã‚’å‘¼ã³å‡ºã—ã¾ã™

ã“ã‚ŒãŒå®Ÿéš›ã®å‡¦ç†å†…å®¹ã§ã™ã€‚

### imperativeHandleEffect é–¢æ•°

#### ã‚·ã‚°ãƒãƒãƒ£

```tsx
function imperativeHandleEffect<T>(
  create: () => T,
  ref: { current: T | null } | ((inst: T | null) => mixed) | null | void
): void | (() => void) {
  // [Not Native Code]
}
```

#### Implementation

æ¸¡ã•ã‚ŒãŸ ref ãŒ ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ ref ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã«åŸºã¥ã„ã¦å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ã„ãšã‚Œã®å ´åˆã‚‚æ¸¡ã•ã‚ŒãŸ`create`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€layout effect ç”¨ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã‚’è¿”ã—ã¾ã™ï¼š

```tsx
if (typeof ref === "function") {
  // step 1
  // highlight-next-line
  const refCallback = ref;
  // step 2
  // highlight-next-line
  const inst = create();
  // step 3
  // highlight-next-line
  refCallback(inst);
  // step 4
  // highlight-next-line
  return () => {
    refCallback(null);
  };
}
```

- **Step 1**: æ¸¡ã•ã‚ŒãŸ ref ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‚ç…§ã‚’ä¿æŒ
- **Step 2**: useImperativeHandle ã® create é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€æ–°ã—ã„ ref ãƒãƒ³ãƒ‰ãƒ«ã‚’ç”Ÿæˆ
- **Step 3**: ç”Ÿæˆã•ã‚ŒãŸãƒãƒ³ãƒ‰ãƒ«ã§ ref ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—
- **Step 4**: ref ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ null ã§å†åº¦å‘¼ã³å‡ºã™ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã‚’è¿”å´

åˆ¥ã®ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã€æ¸¡ã•ã‚ŒãŸ`ref`ãŒ ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€`imperativeHandleEffect`ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```tsx
// å…ƒã€…ã¯else ifç¯€
if (ref !== null && ref !== undefined) {
  // step 1
  // highlight-next-line
  const refObject = ref;
  // step 2
  // highlight-next-line
  const inst = create();
  // step 3
  // highlight-next-line
  refObject.current = inst;
  // step 4
  // highlight-next-line
  return () => {
    refObject.current = null;
  };
}
```

- **Step 1**: æ¸¡ã•ã‚ŒãŸ ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’ä¿æŒ
- **Step 2**: useImperativeHandle ã® create é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€æ–°ã—ã„ ref ãƒãƒ³ãƒ‰ãƒ«ã‚’ç”Ÿæˆ
- **Step 3**: ç”Ÿæˆã•ã‚ŒãŸ ref ãƒãƒ³ãƒ‰ãƒ«ã‚’ ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`current`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å‰²ã‚Šå½“ã¦
- **Step 4**: `current`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ null ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ layout effect ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã‚’è¿”å´

ã“ã‚Œã§å®Œäº†ã§ã™ï¼

:::note
å‰è¿°ã®é€šã‚Šã€`imperativeHandleEffect`ã¯ã‚³ãƒŸãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºã® layout effect ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«å³åº§ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::

## How useInsertionEffect works

[`useInsertionEffect`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useInsertionEffect)ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

> ã™ã¹ã¦ã® layout effects ãŒç™ºç«ã™ã‚‹å‰ã« DOM è¦ç´ ã‚’æŒ¿å…¥ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€css-in-js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½œè€…ã®ã¿ãŒä½¿ç”¨ã™ã¹ããƒ•ãƒƒã‚¯ã§ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã¯`useLayoutEffect`ã¾ãŸã¯`useEffect`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

ä»–ã® effects ã¨åŒæ§˜ã€`useInsertionEffect`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useInsertionEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  // [Not Native Code]
}
```

### å®Ÿè£…

`useInsertionEffect`ã®å®Ÿè£…ã¯[`useEffect`ã¨åŒã˜](#how-useeffect-works)ã§ã™ã€‚å”¯ä¸€ã®é•ã„ã¯ã€ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨æ›´æ–°æ™‚ã«`mountEffectImpl`ã¨`updateEffectImpl`ã«æ¸¡ã•ã‚Œã‚‹`flags`ã§ã™ï¼š

- ãƒã‚¦ãƒ³ãƒˆæ™‚ï¼šReact ã¯ fiber flags ã¨ã—ã¦`UpdateEffect`ã€hook flags ã¨ã—ã¦`HookInsertion`ã‚’æ¸¡ã—ã¾ã™
- æ›´æ–°æ™‚ï¼šReact ã¯ fiber flags ã¨ã—ã¦`UpdateEffect`ã€hook flags ã¨ã—ã¦`HookInsertion`ã‚’æ¸¡ã—ã¾ã™

ã“ã‚Œã ã‘ã§ã™ï¼ã™ã¹ã¦ã® effects ã¯ flags ã®é•ã„ã®ã¿ã§åŒºåˆ¥ã•ã‚Œã¾ã™ã€‚

## How useLayoutEffect works

[`useLayoutEffect`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useLayoutEffect)ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

> ãƒ–ãƒ©ã‚¦ã‚¶ãŒç”»é¢ã‚’å†æç”»ã™ã‚‹å‰ã«ç™ºç«ã™ã‚‹ useEffect ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™

ãŸã ã—ã€useEffect ã¨ã®æ¯”è¼ƒã«ãŠã„ã¦ã“ã‚Œã¯å®Œå…¨ã«æ­£ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[`how commit works`ã‚»ã‚¯ã‚·ãƒ§ãƒ³](/how-react-works/docs/react-dom/how.commit.works#how-commitroot-works)ã§è©³ç´°ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã™ã€‚

`useLayoutEffect`ã¯ã€DOM è¦ç´ ã®å¤‰æ›´å¾Œã«åŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ effect ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚

ãã®åŒæœŸçš„ãªæ€§è³ªã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã€æ–°ã—ã„ UI ã®éƒ¨åˆ†çš„ãªãƒšã‚¤ãƒ³ãƒˆã‚’é˜²ãã¾ã™ã€‚ã“ã‚ŒãŒã€ŒuseLayoutEffect ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒšã‚¤ãƒ³ãƒˆå‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€ã¨è¨€ã‚ã‚Œã‚‹ç†ç”±ã§ã™ã€‚

`useLayoutEffect`ã¯`ClassComponent`ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`componentDidMount`ã¨`componentDidUpdate`)ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

ä»–ã® effects ã¨åŒæ§˜ã€`useInsertionEffect`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useLayoutEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  // [Not Native Code]
}
```

### å®Ÿè£…

`useLayoutEffect`ã®å®Ÿè£…ã¯[`useEffect`ã¨åŒã˜](#how-useeffect-works)ã§ã™ã€‚å”¯ä¸€ã®é•ã„ã¯ã€ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨æ›´æ–°æ™‚ã«`mountEffectImpl`ã¨`updateEffectImpl`ã«æ¸¡ã•ã‚Œã‚‹`flags`ã§ã™ï¼š

- ãƒã‚¦ãƒ³ãƒˆæ™‚ï¼šReact ã¯ fiber flags ã¨ã—ã¦`UpdateEffect | LayoutStaticEffect`ã€hook flags ã¨ã—ã¦`HookLayout`ã‚’æ¸¡ã—ã¾ã™
- æ›´æ–°æ™‚ï¼šReact ã¯ fiber flags ã¨ã—ã¦`UpdateEffect`ã€hook flags ã¨ã—ã¦`HookLayout`ã‚’æ¸¡ã—ã¾ã™

ã“ã‚Œã ã‘ã§ã™ï¼ã™ã¹ã¦ã® effects ã¯ flags ã®é•ã„ã®ã¿ã§åŒºåˆ¥ã•ã‚Œã¾ã™ã€‚

## useMemo ã®ä»•çµ„ã¿

[`useMemo`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useMemo)ã¯ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¾ã§å€¤ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`useMemo`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useMemo<T>(nextCreate: () => T, deps: Array<mixed> | void | null): T {
  // [Not Native Code]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š

- **`nextCreate`**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å€¤ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
- **`deps`**: ä¾å­˜é–¢ä¿‚

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

ãƒã‚¦ãƒ³ãƒˆæ™‚ã€`useMemo`ã¯[`mountMemo`ã‚’å‘¼ã³å‡ºã—ã¾ã™](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2623)ã€‚å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

```tsx
function mountMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null
): T {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const nextDeps = deps === undefined ? null : deps;
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  const nextValue = nextCreate();
  // ã‚¹ãƒ†ãƒƒãƒ—4
  // highlight-next-line
  hook.memoizedState = [nextValue, nextDeps];
  // ã‚¹ãƒ†ãƒƒãƒ—5
  // highlight-next-line
  return nextValue;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: ãƒã‚¦ãƒ³ãƒˆæ™‚ã« hook ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: æä¾›ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã¾ãŸã¯`null`ã‚’ä½¿ç”¨
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: åˆæœŸãƒ¡ãƒ¢å€¤ã‚’è¨ˆç®—
- **ã‚¹ãƒ†ãƒƒãƒ— 4**: `[nextvalue, nextDeps]`ã‚’ hook ã®`memoizedState`ã«ä¿å­˜
- **ã‚¹ãƒ†ãƒƒãƒ— 5**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ã‚’è¿”å´

:::note
é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ StrictMode ãŒæœ‰åŠ¹ãªå ´åˆã€React ã¯`nextCreate`ã‚’ 2 å›å‘¼ã³å‡ºã—ã¾ã™ï¼š

```tsx
// renderWithHooksé–¢æ•°ã§åˆæœŸåŒ–
if (shouldDoubleInvokeUserFnsInHooksDEV) {
  nextCreate();
}
```

:::

### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å®Ÿè£…

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã€`useMemo`ã¯[`updateMemo`ã‚’å‘¼ã³å‡ºã—ã¾ã™](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2637)ã€‚å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

```tsx
function updateMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null
): T {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = updateWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const nextDeps = deps === undefined ? null : deps;
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  const prevState = hook.memoizedState;
  // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã€‚æœªå®šç¾©ã®å ´åˆã€areHookInputsEqualãŒè­¦å‘Šã‚’å‡ºã—ã¾ã™
  if (nextDeps !== null) {
    const prevDeps: Array<mixed> | null = prevState[1];
    // ã‚¹ãƒ†ãƒƒãƒ—4
    // highlight-next-line
    if (areHookInputsEqual(nextDeps, prevDeps)) {
      return prevState[0];
    }
  }
  if (shouldDoubleInvokeUserFnsInHooksDEV) {
    nextCreate();
  }
  // ã‚¹ãƒ†ãƒƒãƒ—5
  // highlight-next-line
  const nextValue = nextCreate();
  // ã‚¹ãƒ†ãƒƒãƒ—6
  // highlight-next-line
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨ã® hook ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆã¾ãŸã¯æœªå®Œäº†ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å†åˆ©ç”¨ï¼‰
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: ä¾å­˜é–¢ä¿‚ã‚’è¨ˆç®—ï¼ˆæä¾›ã•ã‚ŒãŸã‚‚ã®ã‹`null`ï¼‰
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: å‰å›ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚ŒãŸå€¤ã‚’å‚ç…§ï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæœªå®Œäº†ã§ã‚‚ã€å®Ÿéš›ã®å€¤ã‚’ä½¿ç”¨ï¼‰
- **ã‚¹ãƒ†ãƒƒãƒ— 4**: ä¾å­˜é–¢ä¿‚ãŒåŒã˜å ´åˆã€å‰å›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ã‚’è¿”å´
- **ã‚¹ãƒ†ãƒƒãƒ— 5**: æ¸¡ã•ã‚ŒãŸ`nextCreate`ãƒ¡ãƒ¢é–¢æ•°ã§æ–°ã—ã„å€¤ã‚’è¨ˆç®—
- **ã‚¹ãƒ†ãƒƒãƒ— 6**: `[nextValue, nextDeps]`ã‚’ hook ã®`memoizedState`ã«ä¿å­˜ã—ã€æ–°ã—ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥å€¤ã‚’è¿”å´

ã“ã‚Œã§å®Œäº†ã§ã™ï¼`useMemo`ã®å®Ÿè£…ã¯è¤‡é›‘ã•ã®é¢ã§`useCallback`ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€é•ã„ã¯`useMemo`ãŒé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã®ã«å¯¾ã—ã€`useCallback`ã¯é–¢æ•°ãã®ã‚‚ã®ã‚’è¿”ã™ç‚¹ã§ã™ã€‚

## useReducer ã®ä»•çµ„ã¿

[`useReducer`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useReducer)ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« reducer ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

`reducer`ã¨ã¯ã€ç¾åœ¨ã®`value`ã¨é©ç”¨ã™ã‚‹`action`ã‚’å—ã‘å–ã‚Šã€`new value`ã‚’è¿”ã™é–¢æ•°ã§ã™ã€‚ä¾‹ï¼š

```tsx
function reducer(prevValue, action) {
  // actionã¨valueã«åŸºã¥ã„ãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
  // ...
  // æ–°ã—ã„valueã‚’è¿”ã™
}
```

### ã‚·ã‚°ãƒãƒãƒ£

`useReducer`ãƒ•ãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useReducer<S, I, A>(
  reducer: (state: S, action: A) => S,
  initialArg: I,
  init?: (initialValue: I) => S
): [S, Dispatch<A>] {
  // [Not Native Code]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š

- **reducer**: reducer é–¢æ•°
- **initialArg**: åˆæœŸå€¤
- **init**: `initialArg`ã‚’å—ã‘å–ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–é–¢æ•°

è¿”ã‚Šå€¤ã¯ 2 è¦ç´ ã®é…åˆ—ï¼š

- **state**: çŠ¶æ…‹å€¤
- **dispatch**: action ã‚’ reducer ã«æ¸¡ã™é–¢æ•°

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

`useReducer`ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆã‚ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ãã€[`mountReducer`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L1177)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ï¼š

1. work in progress hook ã‚’ãƒã‚¦ãƒ³ãƒˆï¼š

   äºˆæƒ³é€šã‚Šã€æœ€åˆã«è¡Œã†ã®ã¯ã“ã‚Œã§ã™ã€‚ç†ç”±ãŒã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ ğŸ˜‘

   ```tsx
   const hook = mountWorkInProgressHook();
   ```

2. åˆæœŸ state ã‚’è¨ˆç®—ï¼š
   åˆæœŸ state ã®è¨ˆç®—ã¯ã€ç¬¬ä¸‰å¼•æ•°ã‚’æŒ‡å®šã—ãŸã‹ã©ã†ã‹ã«ä¾å­˜ã—ã¾ã™ï¼š

   ```tsx
   let initialState;
   if (init !== undefined) {
     initialState = init(initialArg);
   } else {
     initialState = initialArg as S;
   }
   ```

   `initialArg`ãã®ã‚‚ã®ã‹ã€ãã‚Œã«é–¢æ•°ãŒé©ç”¨ã•ã‚ŒãŸçµæœã®ã„ãšã‚Œã‹ã«ãªã‚Šã¾ã™ã€‚

3. hook ã®`memoizedState`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰²ã‚Šå½“ã¦ï¼š
   ```tsx
   hook.memoizedState = hook.baseState = initialState;
   ```
4. UpdateQueue ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦å‰²ã‚Šå½“ã¦ï¼š

   update queue ã¯`useReducer`ã®å†…éƒ¨çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚ã“ã“ã§ã¯è©³ç´°ã«è§¦ã‚Œã¾ã›ã‚“ãŒã€ä¸»ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã‚„ React ãŒçŠ¶æ…‹æ›´æ–°ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°/å‡¦ç†ã™ã‚‹éš›ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãã®æ§‹é€ ã¨å‚ç…§è¦ç´ ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

   åˆæœŸçŠ¶æ…‹ã§ã¯ã€æœ€åˆã«ä¸ãˆã‚‰ã‚ŒãŸ`reducer`ã¨è¨ˆç®—ã•ã‚ŒãŸ`initialState`ã®ã¿ã‚’å‚ç…§ã—ã¾ã™ï¼š

   ```tsx
   const queue: UpdateQueue<S, A> = {
     pending: null,
     lanes: NoLanes,
     dispatch: null,
     lastRenderedReducer: reducer,
     lastRenderedState: initialState,
   };
   hook.queue = queue;
   ```

5. dispatch é–¢æ•°ã‚’ä½œæˆã—ã¦è¿”å´ï¼š
   ```tsx
   const dispatch: Dispatch<A> = (queue.dispatch = dispatchReducerAction.bind(
     null,
     currentlyRenderingFiber,
     queue
   ));
   return [hook.memoizedState, dispatch];
   ```
   dispatch é–¢æ•°ã¯éå¸¸ã«é‡è¦ã§ã€`mountReducer`ã¯å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã†ã¡ 2 ã¤ã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¦æ¸¡ã—ã¾ã™ã€‚è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### How `dispatchReducerAction` works

`dispatchReducerAction`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function dispatchReducerAction<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A
): void {
  // [Not Native Code]
}
```

ã“ã®é–¢æ•°ã®å½¹å‰²ã¯ã€æŒ‡å®šã•ã‚ŒãŸ`action`ã‚’ä½¿ç”¨ã—ã¦ã€å¯¾è±¡ã®`fiber`ã¨ãã®`queue`ï¼ˆ1 ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¤‡æ•°ã®`useReducer`ã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚Šã€ã‚­ãƒ¥ãƒ¼ã¯å‡¦ç†å¾…ã¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ä¿æŒï¼‰ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã™ã€‚

è¨€ã„æ›ãˆã‚Œã°ã€ã“ã‚Œã¯`useReducer`ã‚„`useState`ãŒæä¾›ã™ã‚‹`dispatch`é–¢æ•°ã®å®Ÿä½“ã§ã™ã€‚

> ã“ã‚Œã§ã€é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãŠã‘ã‚‹ state æ›´æ–°é–¢æ•°ã®ä»•çµ„ã¿ã‚’ç†è§£ã§ãã¾ã™ã€‚

ã“ã®éƒ¨åˆ†ã‚’ç†è§£ã™ã‚‹ã«ã¯ã€[`how root.render() works`ã‚»ã‚¯ã‚·ãƒ§ãƒ³](/how-react-works/docs/react-dom/how.root_render.works#2-request-an-update-lane)ã‚’äº‹å‰ã«èª­ã‚€ã¨ç†è§£ãŒå®¹æ˜“ã§ã™ã€‚é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®åŸºæœ¬çš„ãªä»•çµ„ã¿ã¯åŒã˜ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã«èª¬æ˜ã—ã¾ã™ã€‚

1. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ lane ã‚’è¦æ±‚

   ```tsx
   const lane = requestUpdateLane(fiber);
   ```

   æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ä½¿ç”¨ã™ã‚‹`lane`ã‚’æ±ºå®šã—ã¾ã™ã€‚ä¾‹ï¼š

   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚³ãƒ³ã‚«ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆ`createRoot().render()`ï¼‰ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„å ´åˆã€`SyncLane`ãŒä½¿ç”¨ã•ã‚Œã‚‹
   - ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºä¸­ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å ´åˆã€æœ€é«˜å„ªå…ˆåº¦ã® lane ãŒä½¿ç”¨ã•ã‚Œã‚‹ï¼ˆã¾ãŸã¯æŒ‡å®šã•ã‚ŒãŸ Lanes ç•ªå·å†…ã§æœ€å°ã® laneï¼‰
   - `startTransition`ã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ lane ã® 1 ã¤
   - [root ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä»•çµ„ã¿](/how-react-works/docs/react-dom/how.root_render_schedule.works#implementation-steps)ã§èª¬æ˜ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆå„ªå…ˆåº¦

2. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

   ```tsx
   const update: Update<S, A> = {
     lane,
     revertLane: NoLane,
     action,
     hasEagerState: false,
     eagerState: null,
     next: null,
   };
   ```

   ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯è¤‡æ•°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¡ã¾ã™ãŒã€ã“ã“ã§é‡è¦ãªã®ã¯`lane`ã¨`action`ã§ã™ã€‚React ã¯å¾Œã§å‡¦ç†ã§ãã‚‹ã‚ˆã†ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’ä¿æŒã—ã¾ã™ã€‚`next`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‚’å½¢æˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

3. ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºä¸­ã«å‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã€ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 

   ```tsx
   if (isRenderPhaseUpdate(fiber)) {
     enqueueRenderPhaseUpdate(queue, update);
   }
   ```

   ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯ã€`fiber`ãŒ`currentlyRenderingFiber`ã¾ãŸã¯ãã® alternate ã¨ç­‰ã—ã„å ´åˆã«æ¤œå‡ºã•ã‚Œã¾ã™ã€‚

   ã“ã®å ´åˆã€React ã¯[`enqueueRenderPhaseUpdate`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L3347)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

   ```tsx
   function enqueueRenderPhaseUpdate<S, A>(
     queue: UpdateQueue<S, A>,
     update: Update<S, A>
   ): void {
     // ã‚¹ãƒ†ãƒƒãƒ—1
     didScheduleRenderPhaseUpdateDuringThisPass = didScheduleRenderPhaseUpdate =
       true;
     const pending = queue.pending;
     if (pending === null) {
       // ã‚¹ãƒ†ãƒƒãƒ—2
       update.next = update;
     } else {
       // ã‚¹ãƒ†ãƒƒãƒ—3
       update.next = pending.next;
       pending.next = update;
     }
     // ã‚¹ãƒ†ãƒƒãƒ—4
     queue.pending = update;
   }
   ```

   - **ã‚¹ãƒ†ãƒƒãƒ— 1**: ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã“ã¨ã‚’ãƒãƒ¼ã‚¯ã€‚ã“ã®å¤‰æ•°ã¯ã€React ãŒã‚³ãƒŸãƒƒãƒˆå‰ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã«é‡è¦
   - **ã‚¹ãƒ†ãƒƒãƒ— 2**: ã‚­ãƒ¥ãƒ¼ã«ä¿ç•™ä¸­ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒãªã„å ´åˆã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯è‡ªèº«ã‚’`next`ã¨ã—ã¦æŒ‡ã™
   - **ã‚¹ãƒ†ãƒƒãƒ— 3**: ä¿ç•™ä¸­ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆå¾ªç’°ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆæ§‹é€ ï¼‰ã€æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®`next`ã‚’æœ€åˆã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«è¨­å®šã—ã€å‰ã®æœ€å¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®`next`ã‚’æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«è¨­å®š
   - **ã‚¹ãƒ†ãƒƒãƒ— 4**: æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã®`pending`ï¼ˆæœ€å¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰ã¨ã—ã¦ãƒãƒ¼ã‚¯

4. ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºå¤–ã§å‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ³ã‚«ãƒ¬ãƒ³ãƒˆãƒ•ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼ã—ã€fiber ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ entangle

   ```tsx
   if (false) {
   } else {
     const root = enqueueConcurrentHookUpdate(fiber, queue, update, lane);
     if (root !== null) {
       scheduleUpdateOnFiber(root, fiber, lane);
       entangleTransitionUpdate(root, queue, lane);
     }
   }
   ```

   ã“ã®å‡¦ç†ã¯[`how root.render() works`](/how-react-works/docs/react-dom/how.root_render.works#5-enqueue-the-created-update-to-the-fiber)ã§èª¬æ˜ã—ãŸã‚‚ã®ã¨åŒã˜ã§ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å¼•ãèµ·ã“ã—ãŸ fiber ã® updateQueue ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

:::tip
React ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¯åŠ¹ç‡çš„ãªãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚å­ fiber ã®`flags`ã‚’è¦ªã«é›†ç´„ã™ã‚‹ã“ã¨ã§ã€ä½œæ¥­ã®é–‹å§‹ã¨åœæ­¢ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ­£ç¢ºã«åˆ¤æ–­ã§ãã¾ã™ã€‚

é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

- React ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å³æ™‚å‡¦ç†ã›ãšã€ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦å¾Œã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™
- ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®è©³ç´°ï¼ˆã‚­ãƒ¥ãƒ¼ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/å€¤/ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’è¿½è·¡ã—ã€å¾Œå‡¦ç†å¯èƒ½ã«ä¿æŒ
- ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ãƒãƒƒãƒå‡¦ç†ãŒå¯èƒ½ã«ãªã‚Šã€è¤‡æ•°å›ã§ã¯ãªã 1 å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ¸ˆã¾ã›ã‚‰ã‚Œã¾ã™

:::

### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å®Ÿè£…

<TBD />

## How useRef works

[`useRef`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useRef)ã¯ã€è‡ªç”±ã«åˆ¶å¾¡å¯èƒ½ãªå‚ç…§ã‚’æä¾›ã—ã¾ã™ã€‚ä»»æ„ã® JavaScript ã®å€¤ã‚’å‚ç…§ã§ãã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯æ¬¡ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ï¼š

> useRef ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ä¸è¦ãªå€¤ã‚’å‚ç…§ã§ãã‚‹ React ãƒ•ãƒƒã‚¯ã§ã™

React ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã«ã“ã® ref ã‚’ä½¿ç”¨ã—ã¦åˆ¤æ–­ã‚’ä¸‹ã™ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã›ã‚“ã€‚ãŸã ã—ã€ãƒ¬ãƒ³ãƒ€ãƒ¼å¤–ã§ã®æ“ä½œã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«ã“ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€React ã¯è¤‡æ•°å›ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ãã®çµæœè¤‡æ•°å›æ›¸ãè¾¼ã¾ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’ç¢ºèªã™ã‚‹æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒ¼å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãŸã‚ã« ref ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã‚„ Strict Mode ã§ã¯å¸¸ã«èª¤ã£ãŸçµæœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚ã“ã®ç¨®ã®ä½¿ç”¨æ³•ã‹ã‚‰é›¢ã‚Œã‚‹ã¹ãç†ç”±ã® 1 ã¤ã§ã™ã€‚

ã¾ãŸã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç¾åœ¨ãƒã‚¦ãƒ³ãƒˆä¸­ã‹ã©ã†ã‹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã‚ˆã ref ãŒä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€ã“ã‚Œã‚‚èª¤ã‚Šã§ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ—¢ã«ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã€Suspense ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã—ãªãŒã‚‰ãƒ‡ãƒ¼ã‚¿å¾…ã¡ã§ä¸­æ–­ã—ãŸå ´åˆã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¾ã¾ãªã®ã§ã€ã“ã®å€¤ã«åŸºã¥ãåˆ¤æ–­ã¯ã™ã¹ã¦èª¤ã‚Šã«ãªã‚Šã¾ã™ã€‚

ã“ã® ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ HTML è¦ç´ ã«æ¸¡ã™ã¨ã€React ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ™‚ã«å®Ÿéš›ã® DOM è¦ç´ ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ã“ã‚Œã‚‚ã¾ãŸã€ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«ã“ã®ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã›ãšã€ä½¿ç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã¹ãç†ç”±ã§ã™ã€‚

`useRef`ãƒ•ãƒƒã‚¯ã®é©åˆ‡ãªä½¿ç”¨æ³•ã«ã¤ã„ã¦ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Signature

The `useRef` hook is defined as follows:

```tsx
function mountRef<T>(initialValue: T): { current: T } {
  // [Not Native Code]
}
```

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆã‚ã¦`useRef`ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹éš›ã€[`mountRef`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2257)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒƒã‚¯å®Ÿè£…ã® 1 ã¤ã§ã™ï¼š

```tsx
// ç°¡ç•¥åŒ–ç‰ˆï¼šãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã®refå‚ç…§ã«é–¢ã™ã‚‹é–‹ç™ºè­¦å‘Šã¯å‰Šé™¤
function mountRef<T>(initialValue: T): { current: T } {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const ref = { current: initialValue };
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  hook.memoizedState = ref;
  // ã‚¹ãƒ†ãƒƒãƒ—4
  // highlight-next-line
  return ref;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ãƒ•ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: `useRef`ãŒå—ã‘å–ã£ãŸåˆæœŸå€¤`initialValue`ã§`current`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ãƒƒã‚¯ã®`memoizedState`ã«ä¿å­˜
- **ã‚¹ãƒ†ãƒƒãƒ— 4**: ref ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´

### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å®Ÿè£…

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã€`useRef`ã¯[`updateRef`é–¢æ•°](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2326)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã®å®Ÿè£…ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§è¿½åŠ ã®èª¬æ˜ã¯ä¸è¦ã§ã™ï¼š

```tsx
function updateRef<T>(initialValue: T): { current: T } {
  const hook = updateWorkInProgressHook();
  return hook.memoizedState;
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ•ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãªãŒã‚‰ ref ã®ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾å†åˆ©ç”¨ã—ã€memoized state ã‚’ç›´æ¥è¿”å´ã—ã¾ã™ã€‚

## How useState works

[`useState`ãƒ•ãƒƒã‚¯](https://react.dev/reference/react/useState)ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« state å¤‰æ•°ã‚’è¿½åŠ ã—ã€å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šï¼š

> useState ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« state å¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹ React ãƒ•ãƒƒã‚¯ã§ã™

ç¾åœ¨ React ã«ãŠã„ã¦ã€state ã¯å”¯ä¸€ã®ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã§ã™ï¼ˆPromise ã‚‚å†…éƒ¨çš„ã«ã¯`scheduleUpdateOnFiber`ã‚’å‘¼ã³å‡ºã—ã¾ã™ãŒã€ãã‚Œã‚‰ã ã‘ã§å‹•ä½œã•ã›ã‚‹ã®ã¯å›°é›£ã§ã™ï¼‰ã€‚

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç†è§£ã«ã¯ã€`useReducer`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å‰æã¨ã—ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`useState`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function useState<S>(
  initialState: (() => S) | S
): [S, Dispatch<BasicStateAction<S>>] {
  // [Not Native Code]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š

- **initialState**: åˆæœŸçŠ¶æ…‹å€¤ã¾ãŸã¯åˆæœŸçŠ¶æ…‹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°

### ãƒã‚¦ãƒ³ãƒˆæ™‚ã®å®Ÿè£…

`useState`ã¯å†…éƒ¨çš„ã«`useReducer`ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã® reducer é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```tsx
function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {
  return typeof action === "function" ? action(state) : action;
}
```

ã“ã®ã‚ˆã†ã«ã€é–¢æ•°ã‚’å—ã‘å–ã£ãŸå ´åˆã¯ç¾åœ¨ã® state ã‚’å¼•æ•°ã«ãã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ãã†ã§ãªã„å ´åˆã¯æ¸¡ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ reducer ã‚’ `useReducer` ã«æ¸¡ã™ã“ã¨ã§ã€ç§ãŸã¡ãŒçŸ¥ã£ã¦ã„ã‚‹ `useState` ã®ã‚ˆã†ã«æŒ¯ã‚‹èˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
function useState<S>(
  initialState: (() => S) | S
): [S, Dispatch<BasicStateAction<S>>] {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountStateImpl(initialState);
  const queue = hook.queue;
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  const dispatch: Dispatch<BasicStateAction<S>> = dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue
  );
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  queue.dispatch = dispatch;
  return [hook.memoizedState, dispatch];
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: `mountWIPHook`ã‚’å‘¼ã³å‡ºã—ã€hook ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨`UpdateQueue`ã‚’åˆæœŸåŒ–
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: `dispatch`é–¢æ•°ä½œæˆæ™‚ã«ã‚­ãƒ¥ãƒ¼ã‚’å‚ç…§
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: state ã®ç¾åœ¨å€¤ã¨`dispatch`é–¢æ•°ï¼ˆ`setState`ï¼‰ã‚’å«ã‚€ã‚¿ãƒ—ãƒ«ã‚’è¿”å´

#### `mountStateImpl`ã®å‹•ä½œ

ã“ã®é–¢æ•°ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```tsx
function mountStateImpl<S>(initialState: (() => S) | S): Hook {
  // ã‚¹ãƒ†ãƒƒãƒ—1
  // highlight-next-line
  const hook = mountWorkInProgressHook();
  // ã‚¹ãƒ†ãƒƒãƒ—2
  // highlight-next-line
  if (typeof initialState === 'function') {
    initialState = initialState();
  }
  // ã‚¹ãƒ†ãƒƒãƒ—3
  // highlight-next-line
  hook.memoizedState = hook.baseState = initialState;
  // ã‚¹ãƒ†ãƒƒãƒ—4
  // highlight-next-line
  const queue: UpdateQueue<S, BasicStateAction<S>> = {
    pending: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: basicStateReducer,
    lastRenderedState: (initialState: any),
  };
  hook.queue = queue;
  return hook;
}
```

- **ã‚¹ãƒ†ãƒƒãƒ— 1**: hooks ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆå†…ã« hook ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆ
- **ã‚¹ãƒ†ãƒƒãƒ— 2**: `initialState`ãŒé–¢æ•°ã®å ´åˆã€åˆæœŸåŒ–é–¢æ•°ã‚’å®Ÿè¡Œ
- **ã‚¹ãƒ†ãƒƒãƒ— 3**: hook ã®`memoizedState`ã¨`baseState`ã«åˆæœŸå€¤ã‚’è¨­å®š
- **ã‚¹ãƒ†ãƒƒãƒ— 4**: update queue ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã— hook ã® queue ã«å‰²ã‚Šå½“ã¦

:::tip
ã“ã‚Œã§å®Œäº†ã§ã™ï¼useState ã¯ useReducer ã§ã™ã€‚2018 å¹´ã« hooks ãŒå°å…¥ã•ã‚ŒãŸ[ã‚³ãƒŸãƒƒãƒˆ](https://github.com/facebook/react/commit/7bee9fbdd49aa5b9365a94b0ddf6db04bc1bf51c)ã‚’è¦‹ã‚‹ã¨ã€å®Ÿéš›ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã—ãŸï¼š

```tsx
export function useState<S>(
  initialState: S | (() => S)
): [S, Dispatch<S, BasicStateAction<S>>] {
  return useReducer(basicStateReducer, initialState);
}
```

:::

### Implementation on update

On updates, `updateState` will delegate the work entirely to `updateReducer`,
and that's it!

```tsx
function updateState<S>(
  initialState: (() => S) | S
): [S, Dispatch<BasicStateAction<S>>] {
  return updateReducer(basicStateReducer, initialState);
}
```

## How useDebugValue works

ã“ã‚Œã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿æ©Ÿèƒ½ã™ã‚‹ç©ºã®ãƒ•ãƒƒã‚¯ã§ã™ã€‚

`useDebugValue`ã®å®Ÿè£…ã¯[`mountDebugValue`ã§ç¤ºã•ã‚Œã‚‹é€šã‚Š](https://github.com/facebook/react/blob/77c4ac2ce88736bbdfe0b29008b5df931c2beb1e/packages/react-reconciler/src/ReactFiberHooks.js#L2594)ç©ºã§ã™ï¼š

```tsx
function mountDebugValue<T>(value: T, formatterFn?: (value: T) => mixed): void {
  // é€šå¸¸ã“ã®ãƒ•ãƒƒã‚¯ã¯ä½•ã‚‚ã—ã¾ã›ã‚“
  // react-debug-hooksãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒç‹¬è‡ªå®Ÿè£…ã‚’æ³¨å…¥ã—ã€
  // DevToolsã§ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®å€¤ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
}

const updateDebugValue = mountDebugValue;
```

[`ReactDebugHooks.js`ãƒ•ã‚¡ã‚¤ãƒ«](https://github.com/facebook/react/blob/aec521a96d3f1bebc2ba38553d14f4989c6e88e0/packages/react-debug-tools/src/ReactDebugHooks.js#L238)ã‚’è¦‹ã‚‹ã¨ã€ã“ã®ãƒ•ãƒƒã‚¯ã®å®Ÿè£…ã¯ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚ŒãŸå€¤ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®é…åˆ—ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã ã‘ã§ã€ãã®é…åˆ—ã¯ React DevTools ã«è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±ã‚’åé›†ã—ã¾ã™ã€‚ã“ã‚Œã¯æœ¬è¨˜äº‹ã®ç¯„å›²å¤–ã§ã‚ã‚Šã€ç¾æ™‚ç‚¹ã§ã¯æ–‡æ›¸åŒ–ãŒå›°é›£ãªãŸã‚ã€è©³ã—ãã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚

## How useDeferredValue works

<TBD />

## How useTransition works

<TBD />

## How useSyncExternalStore works

<TBD />

## How useId works

<TBD />

## ä»˜éŒ²

ã“ã‚Œã¯å…¨ã¦ã®ãƒ•ãƒƒã‚¯ã®å†…éƒ¨ä¿å­˜å€¤ã‚’ç¤ºã™è¡¨ã§ã™:

| ãƒ•ãƒƒã‚¯                 | `memoizedState`    | ã‚³ãƒ¡ãƒ³ãƒˆ                                                                                                                                 |
| ---------------------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `use`                  | `N/A`              | `use`ã¯ãƒ•ãƒƒã‚¯ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã‚ãšã€å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“                                                                              |
| `useCallback`          | `[callback, deps]` | `useCallback`ã¯æ¸¡ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ä¾å­˜é…åˆ—ã‚’ä¿å­˜ã—ã¾ã™                                                                                |
| `useContext`           | `N/A`              | `useContext`ã¯ãƒ•ãƒƒã‚¯ã®å‘¼ã³å‡ºã—é †åºã«ä¾å­˜ã›ãšã€`fiber.dependencies`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ã•ã‚Œã¾ã™                                               |
| `useEffect`            | `effect`           | `useEffect`ã¯`pushEffect`ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ã‚„ä¾å­˜é…åˆ—ãªã©ãŒå«ã¾ã‚Œã¾ã™          |
| `useImperativeHandle`  | `effect`           | `useImperativeHandle`ã¯å†…éƒ¨çš„ã«`useLayoutEffect`ã‚’å‘¼ã³å‡ºã—ã¾ã™                                                                           |
| `useLayoutEffect`      | `effect`           | `useLayoutEffect`ã¯`pushEffect`ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ã‚„ä¾å­˜é…åˆ—ãªã©ãŒå«ã¾ã‚Œã¾ã™    |
| `useInsertionEffect`   | `effect`           | `useInsertionEffect`ã¯`pushEffect`ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ã‚„ä¾å­˜é…åˆ—ãªã©ãŒå«ã¾ã‚Œã¾ã™ |
| `useMemo`              | `[value, deps]`    | `useMemo`ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸçµæœå€¤ã¨ä¾å­˜é…åˆ—ã‚’ä¿å­˜ã—ã¾ã™                                                                                  |
| `useReducer`           | `state`            | `useReducer`ã¯ memoizedState ã«çŠ¶æ…‹å€¤ã®ã¿ã‚’ä¿å­˜ã—ã€dispatch ã¯ queue ã«ä¿å­˜ã•ã‚Œã¾ã™                                                      |
| `useRef`               | `{current: value}` | `useRef`ã¯`{current: value}`ã‚’ memoizedState ã¨ã—ã¦ä¿å­˜ã—ã¾ã™                                                                            |
| `useState`             | `state`            | `useState`ã¯ç‰¹åˆ¥ãª reducer ã‚’æŒã¤`useReducer`ã§ã€memoizedState ã«çŠ¶æ…‹å€¤ã®ã¿ã‚’ä¿å­˜ã—ã€dispatch ã¯ queue ã«ä¿å­˜ã•ã‚Œã¾ã™                    |
| `useDebugValue`        | `N/A`              | `useDebugValue`ã¯é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦æ³¨å…¥ã•ã‚Œã‚‹ç©ºã®ãƒ•ãƒƒã‚¯ã§ã™                                                                            |
| `useDeferredValue`     | `TBD`              |                                                                                                                                          |
| `useTransition`        | `TBD`              |                                                                                                                                          |
| `useSyncExternalStore` | `TBD`              |                                                                                                                                          |
| `useId`                | `TBD`              |                                                                                                                                          |
