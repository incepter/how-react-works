---
sidebar_position: 2
---

# `root.render()`ã®å‹•ä½œåŸç†

React ã‚’ä½¿ç”¨ã—ã¦ UI ã‚’ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹éš›ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

- `createRoot`ã§ root ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
- `root.render(ui)`é–¢æ•°ã‚’å‘¼ã³å‡ºã—

```tsx
import { App } from "./app";
import { createRoot } from "react-dom/client";

const container = document.getElementById("root");

// ã“ã‚ŒãŒæœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—
// highlight-next-line
const root = createRoot(container);

// æ¬¡ã«2ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—
// highlight-next-line
root.render(<App />);
```

æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯`root.render`é–¢æ•°ï¼ˆ2 ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã®ã‚·ã‚°ãƒãƒãƒ£ã¨å†…éƒ¨å‹•ä½œã‚’è§£èª¬ã—ã¾ã™ã€‚

## å®šç¾©

### å®£è¨€

Fiber root ã®`render`ãƒ¡ã‚½ãƒƒãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/react-dom/src/client/ReactDOMRoot.js#L102)ã§å®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚·ã‚°ãƒãƒãƒ£

`render`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```tsx
function render(children: ReactNodeList): void {
  // [Not Native Code]
}
```

ç§ãŸã¡ãŒã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’`app`ã‚„`ui`ã¨å‘¼ã³ãŒã¡ãªã®ã¨ã¯å¯¾ç…§çš„ã«ã€React ã®ã‚³ãƒ¼ãƒ‰å†…ã§ã¯`children`ã¨ã—ã¦å‚ç…§ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯`children`ã¨ã„ã†å‘¼ç§°ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã† ğŸ˜‰

ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹ã¯`ReactNodeList`ã§ã€[å®šç¾©ã¯ã“ã¡ã‚‰](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/shared/ReactTypes.js#L22)ã«ã‚ã‚Šã¾ã™ï¼š

```tsx
type ReactNodeList = ReactEmpty | React$Node;

// where:
// highlight-next-line
type ReactEmpty = null | void | boolean;

// and
// highlight-next-line
type React$Node =
  | null
  | boolean
  | number
  | string
  | React$Element<any>
  | React$Portal
  | Iterable<React$Node>;

// where
// highlight-next-line
type React$Element<ElementType extends React$ElementType> = {
  ref: any;
  type: ElementType;
  key: React$Key | null;
  props: React$ElementProps<ElementType>;
};
```

ä¸Šè¨˜ã®å®šç¾©ã‹ã‚‰ã€`render`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§˜ã€…ãªè¦ç´ ã‚’æ¸¡ã™ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆ[ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://codesandbox.io/s/crazy-resonance-jph8kc?file=/src/index.js)ã‚„å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹è¤‡é›‘ãªæ§‹é€ ã‚’å«ã‚€ï¼‰ï¼š

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="html" label="index.html">

```html
<body>
  <div id="root1"></div>
  <hr />
  <div id="root2"></div>
  <hr />
  <div id="root3"></div>
</body>
```

  </TabItem>
  <TabItem value="js" label="index.js" default>

```tsx
import React, { createElement } from "react";
import { createRoot } from "react-dom/client";

createRoot(document.getElementById("root1")).render([
  "Hello ",
  <span key="world" style={{ color: "red" }}>
    World!
  </span>,
]);

class ClassComponent extends React.Component {
  render() {
    const { initialCount } = this.props;

    return <p>Class Count is: {initialCount}</p>;
  }
}

createRoot(document.getElementById("root2")).render([
  <ul key="list">
    <li>First item</li>
    <li>Second</li>
    <li>Last, not third</li>
  </ul>,
  createElement(
    function FunctionComponent({ initialCount }) {
      return <span>Function Count is: {initialCount}</span>;
    },
    { initialCount: 2, key: "count" }
  ),
  <ClassComponent key="class" initialCount={3} />,
]);

createRoot(document.getElementById("root3")).render([
  null,
  true,
  false,
  undefined,
]);
```

  </TabItem>
</Tabs>

è¦ç´„ã™ã‚‹ã¨ã€React Element ã¾ãŸã¯ãã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚React ã¯ã“ã‚Œã‚‰ã‚’å†å¸°çš„ã«ãƒ¬ãƒ³ãƒ€ãƒ¼ã—ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãª UI ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

## å®Ÿè£…

ä¸Šè¨˜ã®å®Ÿè£…ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«ãŠæ°—ã¥ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€`render`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```tsx
// simplified
ReactDOMRoot.prototype.render = function render(children: ReactNodeList): void {
  const root = this._internalRoot;
  if (root === null) {
    throw new Error("Cannot update an unmounted root.");
  }

  // __DEV__ only checks

  updateContainer(children, root, null, null);
};
```

ã“ã®é–¢æ•°ã¯äººé–“ãŒç†è§£ã—ã‚„ã™ã„è¨€è‘‰ã§èª¬æ˜ã™ã‚‹ã¨ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™:

1. `root._internalRoot`ï¼ˆFiberRootNodeï¼‰ãŒ null ã®å ´åˆï¼ˆ`root.unmount`ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã‹æ‰‹å‹•ã§è¡Œã‚ã‚ŒãŸå ´åˆï¼‰ã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
2. `__DEV__`ç’°å¢ƒå‘ã‘ã®[ãƒã‚§ãƒƒã‚¯ã¨è­¦å‘Š](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/react-dom/src/client/ReactDOMRoot.js#L110)ã‚’å®Ÿè¡Œ:
   1. ãƒ¬ã‚¬ã‚·ãƒ¼ãª`ReactDOM.render(children, callback)`ã®ã‚ˆã†ã«ç¬¬ 2 å¼•æ•°ã«é–¢æ•°ã‚’æ¸¡ã—ãŸå ´åˆ
   2. ç¬¬ 2 å¼•æ•°ã« children ã‚’æ¸¡ã—ãŸå ´åˆï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚·ã‚°ãƒãƒãƒ£ä½¿ç”¨ã¨åˆ¤æ–­ï¼‰
   3. ç¬¬ 2 å¼•æ•°ã«ä½•ã‹ã—ã‚‰å€¤ã‚’æ¸¡ã—ãŸå ´åˆ
3. `updateContainer(children, root, null, null)`ã‚’å‘¼ã³å‡ºã—

## `updateContainer`

`updateContainer`ã¯ React ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å¤šãã®ç®‡æ‰€ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã§ã€ãªãœã€Œãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã‚„ã€Œãƒã‚¦ãƒ³ãƒˆã€ã§ã¯ãªãã€Œã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€ã¨ã„ã†åå‰ãªã®ã‹ç–‘å•ã«æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã¯ React ãŒå¸¸ã«ãƒ„ãƒªãƒ¼ã‚’æ›´æ–°ä¸­ã§ã‚ã‚‹ã¨æ‰±ã†ãŸã‚ã§ã™ã€‚React ã¯ãƒ„ãƒªãƒ¼ã®ã©ã®éƒ¨åˆ†ãŒåˆå›ãƒã‚¦ãƒ³ãƒˆã§ã‚ã‚‹ã‹ã‚’èªè­˜ã—ã€å¿…è¦ã«å¿œã˜ã¦é©åˆ‡ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚·ãƒªãƒ¼ã‚ºã®å¾ŒåŠã§è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

ã“ã®é–¢æ•°ã®[å®Ÿè£…](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/react-reconciler/src/ReactFiberReconciler.js#L318)ã‚’åˆ†æã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™:

#### ã‚·ã‚°ãƒãƒãƒ£

```tsx
export function updateContainer(
  element: ReactNodeList, // children
  container: OpaqueRoot, // OpaqueRoot = FiberRoot = new FiberRootNode
  parentComponent?: React$Component<any, any>,
  callback?: Function
): Lane {
  // [Not Native Code]
}
```

ã“ã®é–¢æ•°ã¯å¤šãã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ãƒ„ãƒªãƒ¼ã®åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã¨ãã®å¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

æœ€å¾Œã® 2 ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯`root.render`ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹éš›ã«`null`ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚å¿…è¦ãªå ´åˆã«ã®ã¿èª¬æ˜ã—ã¾ã™ã€‚

ã“ã“ã‹ã‚‰ã¯`updateContainer`ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç°¡ç•¥åŒ–ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

import { S_02_ROOT_RENDER_1, S_02_ROOT_RENDER_2 } from "./components/EL/stacks";
import { EventLoopComponent, AnimatedEventLoop } from "./components/EL";

<EventLoopComponent index={0} stack={S_02_ROOT_RENDER_1} showCallbackQueue={false} />

### 1. **ç¾åœ¨ã®`Fiber`ã¸ã®å‚ç…§**

ã“ã®é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹`container`ã¯ã€`createRoot`ã«æ¸¡ã—ãŸ DOM è¦ç´ ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã“ã‚Œã¯`root._internalRoot`ï¼ˆFiberRootNode å‹ï¼‰ã§ã™ã€‚

å‰ç« ã§å­¦ã‚“ã ã‚ˆã†ã«ã€`container.current`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯`FiberNode`å‹ã§ã™ã€‚ã“ã‚ŒãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½œæˆã•ã‚ŒãŸæœ€åˆã® Fiber ã§ã™ã€‚

React ã¯ã“ã® Fiber ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã€`current`ã¯`fiber`ã¾ãŸã¯`fiberNode`ã‚’æ„å‘³ã—ã¾ã™ã€‚

```tsx
const current = container.current;
```

### 2. **ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨ãƒ¬ãƒ¼ãƒ³ã®è¦æ±‚**

æ¬¡ã« React ã¯ã€ç¾åœ¨ã® Fiber ã«å¯¾ã™ã‚‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨ãƒ¬ãƒ¼ãƒ³ï¼ˆæ•°å€¤ï¼‰ã‚’è¦æ±‚ã—ã¾ã™ï¼š

```tsx
const lane = requestUpdateLane(current);
```

ã“ã‚ŒãŒç§ãŸã¡ãŒåˆã‚ã¦é­é‡ã™ã‚‹æœ¬ç‰©ã®ã€ŒLanesã€ã§ã™ã€‚ç†è§£ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã€ãƒ“ãƒƒãƒˆæ¼”ç®—ã¨ 2 é€²æ•°è¡¨ç¾ã«ã¤ã„ã¦ã®çŸ¥è­˜ãŒå¿…è¦ã§ã™ã€‚

`Lane`ã¯ 2 ã®ç´¯ä¹—æ•°ï¼ˆ1, 2, 4, 8, 16, 32...ï¼‰ã§ã€2 é€²æ•°è¡¨ç¾ã§ 1 ã¤ã®æœ‰åŠ¹ãƒ“ãƒƒãƒˆï¼ˆ1ï¼‰ã®ã¿ã‚’æŒã¤æ•´æ•°ã§ã™ã€‚React ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã¯[ã“ã“ã§å®šç¾©](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L18)ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¸»ãªãƒ¬ãƒ¼ãƒ³ã¨ã—ã¦ä»¥ä¸‹ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

- `SyncLane`
- `InputContinuousLane`
- `IdleLane`
- `OffscreenLane` ãªã©

```tsx
// Reactã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Š
export const NoLane: Lane = /*                          */ 0b0000000000000000000000000000000;

export const SyncHydrationLane: Lane = /*               */ 0b0000000000000000000000000000001;
export const SyncLane: Lane = /*                        */ 0b0000000000000000000000000000010;

export const InputContinuousHydrationLane: Lane = /*    */ 0b0000000000000000000000000000100;
export const InputContinuousLane: Lane = /*             */ 0b0000000000000000000000000001000;

export const DefaultHydrationLane: Lane = /*            */ 0b0000000000000000000000000010000;
export const DefaultLane: Lane = /*                     */ 0b0000000000000000000000000100000;

export const IdleHydrationLane: Lane = /*               */ 0b0010000000000000000000000000000;
export const IdleLane: Lane = /*                        */ 0b0100000000000000000000000000000;

export const OffscreenLane: Lane = /*                   */ 0b1000000000000000000000000000000;
```

ç•°ãªã‚‹ãƒ¬ãƒ¼ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æ–°ã—ã„æ•´æ•°å€¤ï¼ˆæœ€å¤§ 32 çŠ¶æ…‹ï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚é©åˆ‡ãªãƒ“ãƒƒãƒˆãƒã‚¹ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®ãƒ¬ãƒ¼ãƒ³ã‚’ 1 ã¤ã®æ•°å€¤ã«çµåˆã—ã€React ãŒæ©Ÿèƒ½ã‚„æŒ™å‹•ã‚’æ¤œå‡ºãƒ»åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

React ã«ãŠã‘ã‚‹è¤‡æ•°ãƒ¬ãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã‚’ã€ŒLanesã€ã¨å‘¼ã³ã¾ã™ã€‚

```tsx
// Reactã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Š
export const NoLanes: Lanes = /*                        */ 0b0000000000000000000000000000000;

// å€‹äººã‚³ãƒ¡ãƒ³ãƒˆï¼šã“ã‚Œã¯Lanesã§ã‚ã‚‹ã¹ãï¼Ÿ ä¸æ˜
export const SyncUpdateLanes: Lane = /*                */ 0b0000000000000000000000000101010;

const TransitionLanes: Lanes = /*                       */ 0b0000000011111111111111110000000;
```

The [`requestUpdateLane`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L606)ã¯ã€`fiber.mode`ï¼ˆ`FiberNode`ã‹ã‚‰å–å¾—ï¼‰ã‚„ä»–ã®å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦å¿…è¦ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ³ã‚’æ¨è«–ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯åˆæœŸãƒ¬ãƒ³ãƒ€ãƒ¼å¾Œã«ã‚‚å®Ÿè¡Œæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ãã®ã¾ã¾èª¬æ˜ã—ã¾ã™ï¼š

- ãƒ¢ãƒ¼ãƒ‰ãŒ Concurrent ã§ãªã„å ´åˆï¼ˆ`(mode & ConcurrentMode) === NoMode`ï¼‰ã€`SyncLane`ï¼ˆ`2`ï¼‰ãŒè¿”ã•ã‚Œã¾ã™
- **ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ**ï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«`setState`ã‚’å‘¼ã³å‡ºã™ï¼‰ã®å ´åˆã€[æœ€å„ªå…ˆãƒ¬ãƒ¼ãƒ³ãŒè¿”ã•ã‚Œã¾ã™](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L527)ï¼š

  æŠ€è¡“çš„ã«ã¯`lane & -lane`ã§ã€æ•°å€¤ n ã«å¯¾ã—ã¦`n & -n = 2^k`ï¼ˆk ã¯ n ã® 2 é€²è¡¨ç¾ã§æœ€å³ãƒ“ãƒƒãƒˆã®ä½ç½®ï¼‰ã¨ãªã‚Šã¾ã™ã€‚ä»Šå¾Œã¯ã“ã‚Œã‚’`highestPriorityLane`ã¨å‘¼ã³ã¾ã™ï¼ˆã¾ãŸã¯ã€ä¸ãˆã‚‰ã‚ŒãŸ`Lanes`æ•°å€¤å†…ã§æœ€å°ã®`Lane`ğŸ˜‰ï¼‰ã€‚

  React ã®`Lane`ã¯è³¢ãé †åºä»˜ã‘ã•ã‚Œã¦ã„ã¾ã™ï¼š

  ```tsx
  // ä¾‹ï¼šä»»æ„ã®Lanesæ•°å€¤
  // 0b000_1011_0000
  // æœ€å„ªå…ˆãƒ¬ãƒ¼ãƒ³ã¯0b000_0001_0000
  ```

  ã—ãŸãŒã£ã¦ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚’æ›´æ–°ã™ã‚‹å ´åˆã€React ã¯æœ€å„ªå…ˆãƒ¬ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ã¾ã™

- ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒ`Transition`å†…ã§ç™ºç”Ÿã™ã‚‹å ´åˆã€[ã“ã“ã§å®šç¾©ã•ã‚ŒãŸ](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L52) `TransitionLanes`ã‹ã‚‰é¸æŠã—ã€æ¬¡ã«ä½¿ç”¨ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ãƒ¬ãƒ¼ãƒ³ã‚’[ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆ](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L506)ã—ã¾ã™ã€‚`root.render()`ã‹ã‚‰ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶ã™ã‚‹ã«ã¯ã€`startTransition`ã§ãƒ©ãƒƒãƒ—ã—ã¾ã™ï¼š

  ```tsx
  React.startTransition(() => {
    root.render(children);
  });
  ```

- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª[`currentUpdatePriority`](https://github.com/facebook/react/blob/f101c2d0d3a6cb5a788a3d91faef48462e45f515/packages/react-reconciler/src/ReactEventPriorities.js#L29)ãŒè¨­å®šã•ã‚Œã¦ã„ã¦`NoLane`ï¼ˆ`0`ï¼‰ã§ãªã„å ´åˆã€ãã‚ŒãŒè¿”ã•ã‚Œã¾ã™
- ä¸Šè¨˜ã®æ¡ä»¶ã«è©²å½“ã—ãªã„å ´åˆã€React ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒ React å¤–ã‹ã‚‰ç™ºç”Ÿã—ãŸã¨åˆ¤æ–­ã—ã€`Host`ç’°å¢ƒã«`getCurrentEventPriority()`ã‚’è¦æ±‚ã—ã¾ã™ã€‚DOM ç’°å¢ƒã®å ´åˆã€`window.event`ã‚’ä½¿ç”¨ã—ã¦[å„ªå…ˆåº¦ã‚’æ¨è«–](https://github.com/facebook/react/blob/e50531692010bbda2a4627b07c7c810c3770a52a/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js#L597)ã—ã¾ã™

### 3. **ã‚µãƒ–ãƒ„ãƒªãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è§£æ±ºã¨ã‚¢ã‚¿ãƒƒãƒ**

æ¬¡ã« React ã¯ã€[`container(FiberRootNode).context`](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/react-reconciler/src/ReactFiberReconciler.js#L334)ãŒ null ã®å ´åˆã€æ¨è«–ã—ã¦ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ã™ã§ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯`container.pendingContext`ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ã“ã® context ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™

### 4. **`update`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ**

[å‰ç« ](/docs/react-dom/how.createroot.works#recap)ã§å­¦ã‚“ã ã‚ˆã†ã«ã€`FiberNode`ã«ã¯`pending`ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’åé›†ã™ã‚‹`UpdateQueue`ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§æœ€åˆã®æœ¬ç‰©ã®`Update`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ[ä½œæˆã•ã‚Œã¾ã™](https://github.com/facebook/react/blob/80d9a40114bb43c07d021e8254790852f450bd2b/packages/react-reconciler/src/ReactFiberReconciler.js#L358)ï¼š

```tsx
// ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£å¤‰æ•°ï¼š
// - element: root.renderã«æ¸¡ã•ã‚ŒãŸReactãƒãƒ¼ãƒ‰ï¼ˆchildrenã¾ãŸã¯uiï¼‰
// - callback: updateContainerã®æœ€å¾Œã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆroot.renderã‹ã‚‰ã¯nullï¼‰

// ç°¡ç•¥åŒ–ç‰ˆ
const update = {
  lane,
  tag: UpdateState, // 0

  callback, // callbackã¾ãŸã¯null
  payload: { element }, // elementã¯ãƒ«ãƒ¼ãƒˆã®å­è¦ç´ 

  next: null,
};
```

### 5. **ä½œæˆã—ãŸã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’`Fiber`ã«ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼**

ã“ã®æ™‚ç‚¹ã§ã€`updateLane`ã‚’èªè­˜ã—ã€UI ã‚’ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã—ã¦å«ã‚€`FiberRoot`ã«é©ç”¨ã™ã‚‹`Update`ã‚’ä½œæˆã—ã¾ã—ãŸãŒã€ã™ãã«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚React ã¯ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å‡¦ç†ã‚’é©åˆ‡ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã™ï¼š

```tsx
const root: FiberRoot | null = enqueueUpdate(current, update, lane);

// current: FiberNode
// update: Update
// lane: number (update lane)
```

`enqueueUpdate`ã¯ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’çµŒç”±ã—ã¾ã™ï¼š

1. `fiber.updateQueue`ãŒ null ã®å ´åˆã€`null`ã‚’è¿”ã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¹ã‹ã‚‰ã®ã¿`null`ãŒè¿”ã•ã‚Œã€ã“ã®`fiber`ãŒ[ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L227)ã“ã¨ã‚’æ„å‘³ã—ã¾ã™
2. é–‹ç™ºç’°å¢ƒã§ãƒã‚¹ãƒˆã•ã‚ŒãŸ`setState`å‘¼ã³å‡ºã—ã«ã¤ã„ã¦è­¦å‘Šã—ã¾ã™ï¼šåŒã˜`setState(prev => next)`å†…ã‹ã‚‰`setState`ã‚’å‘¼ã³å‡ºã™å ´åˆã€‚ã“ã®è­¦å‘Šã¯ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã«è¡¨ç¤ºã•ã‚Œã€é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯æœ€æ–°ã®`setState`ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚ä¸¡æ–¹ã®ã‚±ãƒ¼ã‚¹ã‚’ç¤ºã™[CodeSandbox ä¾‹](https://codesandbox.io/s/practical-noether-nxlcxv?file=/src/App.js)ãŒã‚ã‚Šã¾ã™ã€‚

   <details>
     <summary>setStateå†…ã§ã®setStateå‘¼ã³å‡ºã—è­¦å‘Š</summary>
     ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯é–‹ç™ºç’°å¢ƒã§è­¦å‘Šã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã¨ã€hooksã®setStateã‹ã‚‰ã¯è­¦å‘ŠãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

   ```tsx
   // ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ‡ãƒ¢ç”¨ã§ã™

   let instance;
   class ClassComponent extends React.Component {
     state = { value: "" };
     render() {
       instance = this;
       return this.state.value;
     }
   }

   let setState;
   function FunctionComponent() {
     let [state, _setState] = React.useState("");
     setState = _setState;
     return state;
   }

   function App() {
     React.useEffect(() => {
       instance.setState(() => {
         console.log("ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®stateã‚’è¨­å®šä¸­");
         // ã“ã®å‘¼ã³å‡ºã—ã¯é–‹ç™ºç’°å¢ƒã§è­¦å‘Šã‚’ç™ºç”Ÿã•ã›ã€æ¯å›setStateã¨è¦‹ãªã—ã¾ã™
         // highlight-next-line
         instance.setState({ value: "Hello !" });
         // highlight-next-line
         return { value: "ã“ã®å€¤ã¯ç„¡è¦–ã•ã‚Œã¾ã™" };
       });
       setState(() => {
         console.log("é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®stateã‚’è¨­å®šä¸­");
         // ã“ã“ã§è¿”ã•ã‚Œã‚‹stateã¯ä¸å®‰å®šã§ã™ã€‚StrictModeãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã§ç•°ãªã‚‹å€¤ãŒå‡ºåŠ›ã•ã‚Œã¾ã™
         // index.jsã§unstable_strictMode: falseã«å¤‰æ›´ã™ã‚‹ã¨å‹•ä½œãŒå¤‰ã‚ã‚Šã¾ã™
         // ã“ã“ã§ã‚‚è­¦å‘ŠãŒå¿…è¦ã§ã™
         // highlight-next-line
         setState("Another value");
         // highlight-next-line
         return "World !";
       });
     }, []);

     return (
       <div>
         <ClassComponent />
         <FunctionComponent />
       </div>
     );
   }
   ```

   </details>

3. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆé–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®`useState`ã‚„`useReducer`ãƒ•ãƒƒã‚¯ã§ã¯ãªã„ï¼‰ã®å ´åˆï¼š

   1. ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å¾ªç’°ã‚­ãƒ¥ãƒ¼`fiber.updateQueue.shared.pending`ã«è¿½åŠ ã—ã¾ã™ï¼š
      æ—¢ã«ä¿ç•™ä¸­ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å…ˆé ­ã«é…ç½®ã—ã€æ—¢å­˜ã®ä¿ç•™ä¸­ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å‚ç…§ã—ã¾ã™ã€‚[ã“ã“ã§ç¢ºèªã§ãã¾ã™](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L252)ã€‚
      æœ€å¤§ 2 è¦ç´ ã®`pending`ã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†ã™ã‚‹éš›ã€ãã‚Œã‚‰ã‚’åˆ‡ã‚Šé›¢ã—ã¦[2 ç•ªç›®ã‹ã‚‰å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L487)ã€‚

   2. ãƒ„ãƒªãƒ¼ã‚’ä¸Šæ–¹å‘ã«èµ°æŸ»ã—ã€ã“ã®ãƒ„ãƒªãƒ¼ã®`FiberRootNode`ã‚’æ¤œç´¢ã—ã¾ã™ï¼š

      ```tsx
      return unsafe_markUpdateLaneFromFiberToRoot(fiber, lane);
      ```

      1. `getRootForUpdatedFiber(fiber)`ã§æœ€åˆã®èµ°æŸ»ã‚’è¡Œã„ã€`fiber.return`ãŒ`null`ã§`HostRoot`ã‚¿ã‚°ã‚’æŒã¤ Fiber ã‚’æ¤œç´¢ã—ã¾ã™ã€‚èµ°æŸ»ä¸­ã€React ã¯ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€[ç•°å¸¸ã‚’æ¤œå‡ºã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™](https://github.com/facebook/react/blob/f101c2d0d3a6cb5a788a3d91faef48462e45f515/packages/react-reconciler/src/ReactFiberConcurrentUpdates.js#L253)ã€‚

      2. `markUpdateLaneFromFiberToRoot(root, null, lane)`ã«ã‚ˆã‚‹ 2 å›ç›®ã®èµ°æŸ»ã§ã¯ã€[`HostRoot`ã«åˆ°é”ã™ã‚‹ã¾ã§](https://github.com/facebook/react/blob/f101c2d0d3a6cb5a788a3d91faef48462e45f515/packages/react-reconciler/src/ReactFiberConcurrentUpdates.js#L194)ã€é­é‡ã™ã‚‹ã™ã¹ã¦ã®è¦ªã«`updateLane`ã‚’è¿½åŠ ã—ã¾ã™ã€‚`OffscreenComponents`ã®ç‰¹åˆ¥ãªã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

4. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã¯ãªã„å ´åˆï¼ˆ`root.render()`ã‹ã‚‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ†å²ï¼‰ã€`enqueueConcurrentClassUpdate(fiber, sharedQueue, update, lane)`ã‚’è¿”ã—ã¾ã™ï¼š

   ```tsx
   // å®šç¾©ï¼ˆç°¡ç•¥åŒ–ï¼‰
   export function enqueueConcurrentClassUpdate<State>(): // ... ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
   FiberRoot | null {
     // {element}ã‚’ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã™ã‚‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã“ã“ã§ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¾ã™
     // highlight-next-line
     enqueueUpdate(fiber, sharedQueue, update, lane);
     // å‰å‡ºã®unsafeãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä½¿ç”¨ã—ãŸ
     // getRootForUpdatedFiberãŒå†ã³ä½¿ç”¨ã•ã‚Œã¾ã™
     return getRootForUpdatedFiber(fiber);
   }
   ```

   ä»Šå›ã®`enqueueUpdate`ã¯[ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™](https://github.com/facebook/react/blob/f101c2d0d3a6cb5a788a3d91faef48462e45f515/packages/react-reconciler/src/ReactFiberConcurrentUpdates.js#L89)ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ä»Šã¯ç„¡è¦–ã—ã¦ãã ã•ã„ï¼‰ï¼š

   1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª`concurrentQueues`ã« 4 ã¤ã®å¼•æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼š

      ```tsx
      // ç°¡ç•¥åŒ–
      concurrentQueues[id++] = fiber;
      concurrentQueues[id++] = sharedQueue;
      concurrentQueues[id++] = update;
      concurrentQueues[id++] = lane;
      ```

      ã“ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¯ React ã®ç‰¹å®šã®å ´æ‰€ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚

   2. `updateLane`ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª`concurrentlyUpdatedLanes`ã«è¿½åŠ ï¼š

      ```tsx
      // ç°¡ç•¥åŒ–
      concurrentlyUpdatedLanes |= lane;
      ```

   3. ãƒ¬ãƒ¼ãƒ³ã‚’`fiber`ï¼ˆ`fiberRoot.current`ï¼‰ã¨ãã®`alternate`ã«ãƒãƒ¼ã‚¸ï¼š
      ```tsx
      fiber.lanes = mergeLanes(fiber.lanes, lane);
      const alternate = fiber.alternate;
      if (alternate !== null) {
        alternate.lanes = mergeLanes(alternate.lanes, lane);
      }
      ```

   æœ€çµ‚çš„ã«ã€`getRootForUpdatedFiber(fiber)`ã‚’é€šã˜ã¦`HostRoot`ãŒè¿”ã•ã‚Œã¾ã™ã€‚

:::note
ã„ãšã‚Œã®æ–¹æ³•ã§ã‚‚ã€`FiberRootNode`å‹ã®`HostRoot`ã‚’å–å¾—ã—ã¾ã™ã€‚`enqueueUpdate(currentFiber, update, lane)`ã®å‘¼ã³å‡ºã—ã¯ãƒ„ãƒªãƒ¼ã®`HostRoot`ã‚’è¿”ã—ã¾ã™ã€‚
:::

ã“ã“ã§ç°¡å˜ã«å¾©ç¿’ã—ã¾ã—ã‚‡ã†ï¼š

`root.render(children)`ã‹ã‚‰å§‹ã¾ã‚Šã€ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã—ãŸï¼š

- `fiberRoot.current`ï¼ˆç¾æ™‚ç‚¹ã§æœ€åˆã«ä½œæˆã•ã‚ŒãŸ Fiberï¼‰ã‚’ä½¿ç”¨
- Transition ã‚„ root ã®`mode`ãªã©ã€å¤šãã®è¦å› ã«ä¾å­˜ã™ã‚‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ³ã‚’è¦æ±‚
- ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã® React `context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ±º
- `Update`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
- ã“ã®`update`ã‚’`Fiber`ã®`updateQueue`ã«ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼

æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§`HostRoot`ï¼ˆ`FiberNode`ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰ã‚’å–å¾—ã—ã¾ã—ãŸã€‚ç¶šãã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### 6. **ç¾åœ¨ã®`Fiber`ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**

ã“ã“ã¾ã§ã§ã€ç¾åœ¨ã®`fiber`ã¯`children`ã‚’ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã™ã‚‹`updateQueue`ã¨`concurrentQueues`é…åˆ—å†…ã®å¤‰æ•°ã‚’æŒã£ã¦ã„ã¾ã™ã€‚æ¬¡ã«ã€ã“ã® Fiber ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ï¼š

```tsx
scheduleUpdateOnFiber(fiberRoot, currentFiber, updateLane);
```

`scheduleUpdateOnFiber`é–¢æ•°ã¯ React ã®å¤šãã®å ´æ‰€ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆã‚»ãƒƒã‚¿ãƒ¼ã‚„ãƒ•ãƒƒã‚¯ãªã©ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã“ã®é–¢æ•°ã¯å¾Œã»ã©ä½•åº¦ã‚‚ç™»å ´ã™ã‚‹ãŸã‚ã€ã“ã“ã§æ¦‚è¦ã‚’èª¬æ˜ã—ã¾ã™ã€‚ç¾åœ¨é–¢ä¿‚ãªã„ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ã¯çœç•¥ã—ã¾ã™ã€‚

[é–¢æ•°ã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L683)ï¼š

1. é–‹ç™ºç’°å¢ƒã§`insertion effects`å®Ÿè¡Œä¸­ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è­¦å‘Š
2. `root`ãŒ`in progress`ã‹ã¤`SuspendedOnData`çŠ¶æ…‹ã®å ´åˆã€React ãŒä½¿ç”¨ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’[ãƒªã‚»ãƒƒãƒˆ](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L711)ã€‚`root.render(children)`ã®ã‚±ãƒ¼ã‚¹ã§ã¯é–¢ä¿‚ãªã„ãŸã‚ã€å¾Œè¿°ã—ã¾ã™
3. `root`ã‚’æ›´æ–°æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ï¼š
   `updateLane`ã‚’`root`ã®`pendingLanes`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œä¿ç•™ä¸­ã®ä½œæ¥­ã‚’è¡¨ã—ã¾ã™ã€‚

   `update`ãŒ`Idle`ã§ãªã„å ´åˆï¼ˆ`root.render(children)`ã‹ã‚‰ã®ã‚±ãƒ¼ã‚¹ï¼‰ã€`root`ã®`suspendedLanes`ã¨`pingedLanes`ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒãƒ„ãƒªãƒ¼ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

   ```tsx
   export function markRootUpdated(root: FiberRoot, updateLane: Lane) {
     root.pendingLanes |= updateLane;

     if (updateLane !== IdleLane) {
       root.suspendedLanes = NoLanes;
       root.pingedLanes = NoLanes;
     }
   }
   ```

4. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒ`render phase update`ã®å ´åˆã€ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã®æ›´æ–°ã‚’è­¦å‘Š
5. é€šå¸¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å ´åˆï¼š
   1. [`ensureRootIsScheduled(root)`](https://github.com/facebook/react/blob/dd480ef923930c8906a02664b01bcdea50707b5d/packages/react-reconciler/src/ReactFiberWorkLoop.js#L796)ã‚’å‘¼ã³å‡ºã—ï¼š
      1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°`firstScheduledRoot`ã¨`lastScheduledRoot`ã« root ã‚’ç™»éŒ²
      2. ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼š[`scheduleMicrotask`](https://github.com/facebook/react/blob/7f362de1588d98438787d652941533e21f2f332d/packages/react-reconciler/src/ReactFiberRootScheduler.js#L470)ã‚’ä½¿ç”¨ã—ã¦[`processRootScheduleInMicrotask`](https://github.com/facebook/react/blob/7f362de1588d98438787d652941533e21f2f332d/packages/react-reconciler/src/ReactFiberRootScheduler.js#L233)ã‚’å®Ÿè¡Œã€‚`scheduledRoots`ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†ã—ã¾ã™ï¼š
         ```tsx
         scheduleImmediateTask(processRootScheduleInMicrotask);
         ```
         å‡¦ç†ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã•ã‚Œã€å®Ÿè¡Œã¯å¾Œã»ã©è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™
   2. `root`ãŒ`Legacy`ã®å ´åˆã€å³åº§ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥

### 7. **`Fiber`ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ entangle**

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚ã“ã“ã¾ã§åˆ°é”ã—ãŸã‚ãªãŸã¯å¥½å¥‡å¿ƒã¨é‡å¿ƒã®æŒã¡ä¸»ã§ã™ã€‚é•·ãè¤‡é›‘ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã—ãŸãŒã€ã“ã‚ŒãŒæœ€å¾Œã®éƒ¨åˆ†ã§ã™ã€‚

åˆå›ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒåŸºæœ¬çš„ãªå ´åˆï¼ˆä¾‹ï¼šã‚·ãƒ³ãƒ—ãƒ«ãª`root.render()`ï¼‰ï¼š

```tsx
createRoot(container).render(children);
```

ã“ã®å ´åˆã€[ã“ã®é–¢æ•°](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L274)ã§ã¯ä½•ã‚‚è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

ã—ã‹ã—`startTransition`ã§`render`ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å ´åˆï¼š

```tsx
function entangleTransitions(root: FiberRoot, fiber: Fiber, lane: Lane) {
  const sharedQueue = fiber.updateQueue.shared;

  if (isTransition(lane)) {
    let queueLanes = sharedQueue.lanes;

    queueLanes &= root.pendignLanes;

    const newLanes = queueLanes | lane;
    sharedQueue.lanes = newQueueLanes;

    markRootEntangled(root, newLanes);
  }
}
```

- `fiber`ã®`shared.lanes`ã¯`root`ã®[`pendingLanes`](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L290)ã¨äº¤å·®ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šä¸¡æ–¹ã«å­˜åœ¨ã™ã‚‹å…±é€šã®ãƒ¬ãƒ¼ãƒ³ã®ã¿ãŒæ®‹ã‚Šã¾ã™

- æ¬¡ã«ã€[ã“ã®ã‚±ãƒ¼ã‚¹](https://github.com/facebook/react/blob/4bbac04cd3624962900bb7800ba4f9609d3a1fd3/packages/react-reconciler/src/ReactFiberClassUpdateQueue.js#L293)ã§`TransitionLane`ã‚’å«ã‚€`updateLane`ã¨ãƒãƒ¼ã‚¸ã•ã‚Œã€`fiber.updateQueue.shared.lanes`ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™

- æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯[`markRootEntangled(root, newQueueLanes)`](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L673)ã®å‘¼ã³å‡ºã—ã§ã™ã€‚è¤‡é›‘ãªãƒ—ãƒ­ã‚»ã‚¹ã®ãŸã‚ã€æ®µéšçš„ã«èª¬æ˜ã—ã¾ã™ï¼š

  1. `newQueueLanes`ã‚’`root.entangledLanes`ã«è¿½åŠ 
  2. ãƒ«ãƒ¼ãƒ—å‰ã«`root.entanglements`é…åˆ—ã‚’å‚ç…§
  3. `lanes`å¤‰æ•°ã¨ã—ã¦å‚ç…§ã—ã€`lanes`ãŒ`0`ã§ãªã„é–“ãƒ«ãƒ¼ãƒ—ï¼š

     1. ç¾åœ¨ã®[`lanes`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L690)ï¼š
        ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯`31`ã‹ã‚‰ç¾åœ¨ã®`lanes`æ•°å€¤ã®[å…ˆé ­ã®ã‚¼ãƒ­ã®æ•°](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/clz32)ã‚’å¼•ã„ãŸå€¤ã€‚ã“ã‚Œã¯ç¾åœ¨ã®`lanes`ã® 2 é€²è¡¨ç¾ã§æœ€åˆã®æœ‰åŠ¹ãƒ“ãƒƒãƒˆï¼ˆ`1`ï¼‰ã®ä½ç½®ã§ã™
     2. `lanes`æ•°å€¤ãŒè¤‡æ•°ã®ãƒ¬ãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã®å ´åˆã€æœ€ä¸Šä½ãƒ“ãƒƒãƒˆã®`lane`ã¯å–å¾—ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ†å·¦ã‚·ãƒ•ãƒˆã—ã¦è¨ˆç®—ï¼š

        ```tsx
        const lane = 1 << index;

        // ä¾‹ï¼š
        // lanes = 21ï¼ˆ0b0000_0000_0000_0000_0000_0000_0001_0101ï¼‰
        // clz32(lanes) = 27
        // 31 - clz32(lanes) = 4
        // 1 << 4 = 0b0000_0000_0000_0000_0000_0000_0001_0000ï¼ˆ16ï¼‰
        // ã“ã‚Œã¯æœ€å„ªå…ˆåº¦ãŒä½ã„ãƒ¬ãƒ¼ãƒ³ï¼ˆæ•°å€¤ãŒæœ€ã‚‚é«˜ã„ï¼‰ã‚’ç¤ºã™
        ```

     3. ãƒ¬ãƒ¼ãƒ³ãŒ`newQueueLanes`ã«å­˜åœ¨ã—ã€`newQueueLanes`ã¨æ¨ç§»çš„ã«é–¢é€£ã—ã¦ã„ã‚‹å ´åˆã€`newQueueLanes`ã‚’[ãƒ¬ãƒ¼ãƒ³ã® entanglement ã«è¿½åŠ ](https://github.com/facebook/react/blob/fc801116c80b68f7ebdaf66ac77d5f2dcd9e50eb/packages/react-reconciler/src/ReactFiberLane.js#L689)ï¼š

        ```tsx
        // very simplified
        // non-zero will be equal to the lane itself
        const laneOrZero = lane & newQueueLanes;

        // the existing entanglements at index
        const entagledLanesAtIndex = entanglements[index];
        // lanes that were entangled intersecting with new queue lanes
        // those are lanes that were present already and are coming again
        const persistingLanesAtIndex = entagledLanesAtIndex & newQueueLanes;

        // this means that either this lane is directly present in the new lanes
        // or that it is transitively present from the previous entanglements
        if (laneOrZero | persistingLanesAtIndex) {
          // add the new lanes to the existing entanglements
          entanglements[index] |= newQueueLanes;
        }
        ```

     4. ç¾åœ¨ã®`lane`ã‚’`lanes`ã‹ã‚‰å‰Šé™¤ã—ã€`lanes`ãŒ`0`ã«ãªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ç¶™ç¶š

ã“ã‚Œã§`updateContainer(children, root, null, null)`ãŒçµ‚äº†ã—ã¾ã™ã€‚

## ã¾ã¨ã‚

`root.render(children)`ã®ä¸»ãªç›®çš„ã¯ã€`updateContainer`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦`root._internalRoot.current.shared.pending`ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®éš›ã€`children`ã‚’`element`ã¨ã—ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ä¿æŒã—ã¾ã™ã€‚

ã“ã®å‡¦ç†ä¸­ã€React ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ç™ºç”Ÿæºã«ã¤ã„ã¦å¤šãã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚`root.render()`ã‹ã‚‰ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã»ã¨ã‚“ã©ã®ãƒã‚§ãƒƒã‚¯ãŒè©²å½“ã—ã¾ã›ã‚“ãŒã€çŸ¥ã£ã¦ãŠãã“ã¨ãŒé‡è¦ã§ã™ã€‚

ç¾æ™‚ç‚¹ã§æœ€ã‚‚é‡è¦ãªéƒ¨åˆ†ã¯`scheduleImmediateTask(processRootScheduleInMicrotask)`ã§ã™ã€‚ã“ã‚Œã¯å¾Œã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ãŒã€ã¾ã è©³ç´°ã¯èª¬æ˜ã—ã¦ã„ã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¯ç†ç”±ãŒã‚ã‚Šã¾ã™ï¼šãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ—ãŒé–‹å§‹ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚

:::note
`createRoot(container, options)`ã¨`root.render(children)`ã®å†…éƒ¨å‹•ä½œã‚’è¦‹ã¦ãã¾ã—ãŸãŒã€React ã¯ã¾ã ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚`queueMicrotask`ã‚’é€šã˜ã¦ä½œæ¥­ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ãŸã ã‘ã§ã™ã€‚

ã“ã‚Œã¯ã€React ãŒã‚ãªãŸã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’`index.js`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Œäº†ã—ãŸå¾Œã«ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ ğŸ˜‰ã€‚

<AnimatedEventLoop stack={S_02_ROOT_RENDER_2} />

ã“ã®æ©Ÿä¼šã‚’åˆ©ç”¨ã—ã¦ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã©ã‚’çµŒç”±ã›ãšã«é‡è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã€åˆæœŸçŠ¶æ…‹ã§`pending`çŠ¶æ…‹ã«å…¥ã£ãŸã‚Šã‚µã‚¹ãƒšãƒ³ãƒ‰ã—ãŸã‚Šã§ãã¾ã™ã€‚ä¾‹ãˆã°ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£æ±ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚
:::
